<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BUNCA — Rohwaren</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
  <style>
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .w100{width:100%} .w120{width:120px} .w80{width:80px}
    .muted small{font-size:12px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center}
    .modal .box{background:#0f1320;border:1px solid #22283b;border-radius:14px;padding:16px;max-width:560px;width:90%}
    textarea{min-height:140px}
  </style>
</head>
<body>
<header class="header">
  <nav class="nav">
    <div style="font-weight:800">BUNCA Planner</div>
    <div class="tabs">
      <a class="tab" data-tab="materials" href="/materials.html">Rohwaren</a>
      <a class="tab" data-tab="import" href="/import.html">Import</a>
      <a class="tab" data-tab="dash" href="/dashboard.html">Übersicht</a>
    </div>
    <div><button id="logout" class="btn">Logout</button></div>
  </nav>
</header>

<div class="container">
  <div class="card">
    <div class="row">
      <h2 style="margin-right:auto">Rohwaren</h2>
      <button id="addRow" class="btn">+ Neu</button>
      <button id="bulkBtn" class="btn">Bulk Preise</button>
      <button id="reload" class="btn">Neu laden</button>
    </div>
    <p class="muted"><small>Bearbeite Felder direkt in der Tabelle und klicke „Speichern“.</small></p>

    <div style="overflow:auto">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Code</th><th>Name</th><th>Base Unit</th>
            <th>Pack Qty</th><th>Pack Unit</th><th>Pack Price</th>
            <th>€ / base-unit</th><th>Supplier</th><th>Note</th><th></th><th></th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Bulk modal -->
<div id="modal" class="modal">
  <div class="box">
    <h3>Bulk Preise einfügen</h3>
    <p class="muted"><small>Format: <code>CODE | 0.00123</code> pro Zeile</small></p>
    <textarea id="bulkText" class="input w100"></textarea>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="bulkCancel" class="btn">Abbrechen</button>
      <button id="bulkSave" class="btn primary">Speichern</button>
    </div>
  </div>
</div>

<!-- History modal -->
<div id="histModal" class="modal">
  <div class="box">
    <h3>Preisverlauf: <span id="histTitle"></span></h3>
    <div style="max-height:260px;overflow:auto">
      <table class="table">
        <thead><tr><th>Preis</th><th>Datum</th></tr></thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="histClose" class="btn">Schließen</button>
    </div>
  </div>
</div>

<script>
navActive('materials');
document.getElementById('logout').onclick = async () => {
  await api('/api/logout', { method:'POST' });
  location.href = '/login.html';
};

const T = (tag, attrs={}, ...kids) => {
  const el = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v]) => el.setAttribute(k, v));
  kids.forEach(k => el.append(k));
  return el;
};

const bodyEl = document.getElementById('body');
const reloadBtn = document.getElementById('reload');
const addRowBtn = document.getElementById('addRow');
const bulkBtn = document.getElementById('bulkBtn');

async function load() {
  bodyEl.innerHTML = '<tr><td colspan="11" class="muted">Lade…</td></tr>';
  try {
    const { data } = await api('/api/materials');
    render(data);
  } catch (e) {
    bodyEl.innerHTML = `<tr><td colspan="11" class="muted">Fehler: ${e.message}</td></tr>`;
  }
}

function render(rows) {
  bodyEl.innerHTML = '';
  rows.forEach(r => addRow(r));
}

function addRow(r = {}) {
  const tr = document.createElement('tr');

  const code = T('input', { class:'input w120', value: r.code || '' });
  const name = T('input', { class:'input w100', value: r.name || '' });
  const base_unit = T('input', { class:'input w80', value: r.base_unit || 'g' });
  const pack_qty = T('input', { class:'input w80', value: r.pack_qty ?? '' });
  const pack_unit = T('input', { class:'input w80', value: r.pack_unit ?? '' });
  const pack_price = T('input', { class:'input w80', value: r.pack_price ?? '' });
  const ppu = T('input', { class:'input w100', value: r.price_per_unit ?? '' });
  const supplier = T('input', { class:'input w120', value: r.supplier_code ?? '' });
  const note = T('input', { class:'input w100', value: r.note ?? '' });

  const saveBtn = T('button', { class:'btn primary' }, 'Speichern');
  saveBtn.onclick = async () => {
    try {
      await api('/api/materials', {
        method:'POST',
        body: JSON.stringify({
          code: code.value.trim(),
          name: name.value.trim(),
          base_unit: base_unit.value.trim() || 'g',
          pack_qty: numOrNull(pack_qty.value),
          pack_unit: pack_unit.value.trim() || null,
          pack_price: numOrNull(pack_price.value),
          price_per_unit: numOrNull(ppu.value) ?? 0,
          supplier_code: supplier.value.trim() || null,
          note: note.value.trim()
        })
      });
      toast('Gespeichert');
    } catch (e) {
      toast('Fehler: ' + e.message, false);
    }
  };

  const histBtn = T('button', { class:'btn' }, 'Verlauf');
  histBtn.onclick = () => openHistory(code.value.trim());

  tr.append(
    td(code), td(name), td(base_unit),
    td(pack_qty), td(pack_unit), td(pack_price),
    td(ppu), td(supplier), td(note),
    td(saveBtn), td(histBtn)
  );
  bodyEl.append(tr);
}

function td(child){ const td = document.createElement('td'); td.append(child); return td; }
function numOrNull(v){ if (v==='' || v==null) return null; const n=Number(String(v).replace(',','.')); return Number.isFinite(n)?n:null; }

reloadBtn.onclick = load;
addRowBtn.onclick = () => addRow({ base_unit:'g' });

/* bulk prices modal */
const modal = document.getElementById('modal');
const bulkText = document.getElementById('bulkText');
document.getElementById('bulkCancel').onclick = () => { modal.style.display='none'; };
bulkBtn.onclick = () => { bulkText.value=''; modal.style.display='flex'; };
document.getElementById('bulkSave').onclick = async () => {
  try {
    await api('/api/materials/bulk-prices', { method:'POST', body: JSON.stringify({ text: bulkText.value }) });
    modal.style.display='none';
    toast('Preise aktualisiert');
    load();
  } catch(e){ toast('Fehler: '+e.message, false); }
};

/* history modal */
const histModal = document.getElementById('histModal');
const histTitle = document.getElementById('histTitle');
const histBody = document.getElementById('histBody');
document.getElementById('histClose').onclick = () => { histModal.style.display='none'; };

async function openHistory(code){
  if (!code) return;
  try {
    const { data } = await api(`/api/materials/${encodeURIComponent(code)}/history`);
    histTitle.textContent = code;
    histBody.innerHTML = data.length
      ? data.map(x=>`<tr><td>${x.price_per_unit}</td><td>${new Date(x.changed_at).toLocaleString()}</td></tr>`).join('')
      : '<tr><td colspan="2" class="muted">Keine Einträge</td></tr>';
    histModal.style.display='flex';
  } catch(e){ toast('Fehler beim Laden des Verlaufs', false); }
}

load();
</script>
</body>
</html>
