<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>BUNCA – Rezepte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-stone-50 text-stone-900">
<header class="bg-white border-b border-stone-200">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <a href="/" class="h-8 w-8 rounded-lg bg-emerald-600 block"></a>
      <h1 class="text-lg font-semibold tracking-tight">Rezepte</h1>
    </div>
    <nav class="flex items-center gap-2 text-sm">
      <a href="/plan.html" class="px-3 py-1.5 rounded-lg hover:bg-stone-100">Plan</a>
      <a href="/materials.html" class="px-3 py-1.5 rounded-lg hover:bg-stone-100">Rohwaren</a>
      <button id="logoutBtn" class="ml-2 px-3 py-1.5 rounded-lg bg-stone-900 text-white hover:bg-stone-800">Logout</button>
    </nav>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Left: list -->
  <section class="lg:col-span-1 bg-white rounded-2xl shadow overflow-hidden">
    <div class="px-4 py-3 border-b border-stone-200 flex items-center justify-between">
      <div class="font-semibold">Produkte</div>
      <button id="newItemBtn" class="px-3 py-1.5 rounded-lg border border-stone-300 hover:bg-stone-100 text-sm">Neu</button>
    </div>
    <div class="p-3">
      <input id="search" placeholder="Suche…" class="w-full rounded-xl border border-stone-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500">
    </div>
    <ul id="itemList" class="max-h-[60vh] overflow-auto divide-y divide-stone-100"></ul>
  </section>

  <!-- Right: editor -->
  <section class="lg:col-span-2 bg-white rounded-2xl shadow overflow-hidden">
    <div class="px-5 py-4 border-b border-stone-200 flex items-center justify-between">
      <h3 id="editorTitle" class="font-semibold">Rezept Editor</h3>
      <div class="flex items-center gap-2">
        <button id="saveItemBtn" class="px-3 py-1.5 rounded-lg bg-stone-900 text-white hover:bg-stone-800 text-sm">Stammdaten speichern</button>
        <button id="saveBomBtn" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">Zutaten speichern</button>
      </div>
    </div>

    <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-5">
      <div class="space-y-3">
        <div>
          <label class="text-sm">Code</label>
          <input id="code" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Name</label>
          <input id="name" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm">Yield (Menge)</label>
            <input id="yieldQty" type="number" step="0.01" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2">
          </div>
          <div>
            <label class="text-sm">Einheit</label>
            <select id="yieldUnit" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2">
              <option value="pcs">Stück</option>
              <option value="g">g</option>
              <option value="ml">ml</option>
            </select>
          </div>
        </div>
        <div>
          <label class="text-sm">Kategorie</label>
          <input id="category" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2">
        </div>
        <div>
          <label class="text-sm">Notiz</label>
          <input id="note" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2">
        </div>
      </div>

      <div class="space-y-3">
        <div class="flex items-end justify-between gap-3">
          <div>
            <label class="text-sm">Kosten (Batch)</label>
            <div id="batchCost" class="text-2xl font-semibold">—</div>
          </div>
          <div>
            <label class="text-sm">Kosten pro Stück</label>
            <div id="pieceCost" class="text-2xl font-semibold">—</div>
          </div>
        </div>

        <div class="border-t border-stone-200 pt-4">
          <label class="text-sm">Skalierung – Vorschau</label>
          <div class="mt-2 flex items-center gap-2">
            <input id="scaleQty" type="number" step="1" class="w-28 rounded-xl border border-stone-300 px-3 py-2" placeholder="Menge">
            <button id="scaleBtn" class="px-3 py-2 rounded-xl border border-stone-300 hover:bg-stone-100 text-sm">Vorschau</button>
          </div>
          <div id="scaleBox" class="mt-3 text-sm text-stone-600 hidden"></div>
        </div>
      </div>
    </div>

    <div class="px-5 pb-5">
      <div class="flex items-center justify-between mb-2">
        <h4 class="font-medium">Zutaten (BOM)</h4>
        <button id="addLineBtn" class="px-3 py-1.5 rounded-lg border border-stone-300 hover:bg-stone-100 text-sm">Zeile hinzufügen</button>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-stone-50">
            <tr>
              <th class="text-left px-4 py-2">Rohware</th>
              <th class="text-left px-4 py-2">Menge</th>
              <th class="text-left px-4 py-2">Einheit</th>
              <th class="text-left px-4 py-2"></th>
            </tr>
          </thead>
          <tbody id="bomBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
async function guard() {
  const s = await fetch('/api/session').then(r=>r.json());
  if (!s.user) location.href = '/login.html';
}
function euro(n){ return new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR'}).format(n||0); }
let ITEMS = [];
let MATS = [];
let CURRENT = null;

function itemLi(it) {
  return `<li data-code="${it.code}" class="px-4 py-3 hover:bg-stone-50 cursor-pointer">
    <div class="font-medium">${it.name}</div>
    <div class="text-xs text-stone-500">${it.code} • Yield: ${it.yield_qty} ${it.yield_unit}</div>
  </li>`;
}

function matOptions(selCode) {
  return MATS.map(m=>`<option value="${m.code}" ${m.code===selCode?'selected':''}>${m.name} (${m.unit})</option>`).join('');
}
function bomRow(line) {
  return `<tr class="border-b border-stone-100">
    <td class="px-4 py-2">
      <select class="w-72 rounded-lg border border-stone-300 px-2 py-1.5">
        ${matOptions(line?.material_code)}
      </select>
    </td>
    <td class="px-4 py-2"><input type="number" step="0.01" value="${line?.qty ?? ''}" class="w-28 rounded-lg border border-stone-300 px-2 py-1.5"></td>
    <td class="px-4 py-2"><input type="text" value="${line?.unit ?? ''}" class="w-20 rounded-lg border border-stone-300 px-2 py-1.5"></td>
    <td class="px-4 py-2"><button class="del px-3 py-1.5 rounded-lg border border-stone-300 hover:bg-stone-100">Löschen</button></td>
  </tr>`;
}

async function loadLists() {
  const items = await fetch('/api/items').then(r=>r.json());
  ITEMS = items.data || [];
  const mats = await fetch('/api/materials').then(r=>r.json());
  MATS = mats.data || [];
  // list
  const UL = document.getElementById('itemList');
  const q = document.getElementById('search').value.trim().toLowerCase();
  const filtered = ITEMS.filter(i => !q || i.name.toLowerCase().includes(q) || i.code.toLowerCase().includes(q));
  UL.innerHTML = filtered.map(itemLi).join('');
  // click
  UL.querySelectorAll('li').forEach(li=>{
    li.onclick = ()=> openItem(li.getAttribute('data-code'));
  });
}

async function openItem(code) {
  const it = ITEMS.find(i => i.code === code);
  if (!it) return;
  CURRENT = it.code;
  document.getElementById('editorTitle').textContent = `Rezept Editor – ${it.name}`;
  document.getElementById('code').value = it.code;
  document.getElementById('name').value = it.name;
  document.getElementById('yieldQty').value = it.yield_qty;
  document.getElementById('yieldUnit').value = it.yield_unit;
  document.getElementById('category').value = it.category || '';
  document.getElementById('note').value = it.note || '';
  // load BOM
  const r = await fetch(`/api/items/${encodeURIComponent(code)}/bom`).then(r=>r.json());
  const lines = r.data || [];
  const TB = document.getElementById('bomBody');
  TB.innerHTML = lines.map(bomRow).join('');
  wireBomTable();
  // compute costs at batch yield
  await recomputeCosts();
}

function wireBomTable() {
  document.querySelectorAll('#bomBody .del').forEach(b=>{
    b.onclick = (e)=> e.target.closest('tr').remove();
  });
}

function readBom() {
  const out = [];
  document.querySelectorAll('#bomBody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    out.push({
      material_code: tds[0].querySelector('select').value,
      qty: Number(tds[1].querySelector('input').value || 0),
      unit: tds[2].querySelector('input').value || ''
    });
  });
  return out;
}

async function saveItem() {
  const payload = {
    code: document.getElementById('code').value.trim(),
    name: document.getElementById('name').value.trim(),
    category: document.getElementById('category').value.trim(),
    yield_qty: Number(document.getElementById('yieldQty').value || 1),
    yield_unit: document.getElementById('yieldUnit').value,
    note: document.getElementById('note').value.trim()
  };
  const r = await fetch('/api/items', {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify(payload)
  });
  if (r.ok) {
    alert('Stammdaten gespeichert.');
    await loadLists();
  } else alert('Fehler beim Speichern.');
}

async function saveBom() {
  const code = document.getElementById('code').value.trim();
  const lines = readBom();
  const r = await fetch(`/api/items/${encodeURIComponent(code)}/bom`, {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ lines })
  });
  if (r.ok) {
    alert('Zutaten gespeichert.');
    await openItem(code);
  } else alert('Fehler beim Speichern.');
}

async function recomputeCosts() {
  const code = document.getElementById('code').value.trim();
  const yq = Number(document.getElementById('yieldQty').value || 1);
  const res = await fetch(`/api/items/${encodeURIComponent(code)}/scale?qty=${yq}`).then(r=>r.json());
  if (!res.ok) { document.getElementById('batchCost').textContent = '—'; document.getElementById('pieceCost').textContent='—'; return; }
  const total = res.data.total_cost || 0;
  document.getElementById('batchCost').textContent = euro(total);
  document.getElementById('pieceCost').textContent = euro(yq ? total / yq : total);
}

document.getElementById('addLineBtn').onclick = ()=>{
  const tb = document.getElementById('bomBody');
  const row = document.createElement('tr');
  row.innerHTML = bomRow({});
  tb.appendChild(row);
  wireBomTable();
};

document.getElementById('saveItemBtn').onclick = saveItem;
document.getElementById('saveBomBtn').onclick = saveBom;

document.getElementById('scaleBtn').onclick = async ()=>{
  const code = document.getElementById('code').value.trim();
  const qty = Number(document.getElementById('scaleQty').value || 0);
  if (!qty) return;
  const r = await fetch(`/api/items/${encodeURIComponent(code)}/scale?qty=${qty}`).then(r=>r.json());
  if (!r.ok) return;
  const box = document.getElementById('scaleBox');
  const lines = r.data.lines || [];
  box.classList.remove('hidden');
  box.innerHTML = `
    <div class="text-stone-700 mb-1">Skaliert auf <strong>${qty}</strong>:</div>
    <ul class="list-disc pl-6">
      ${lines.map(l=>`<li>${l.material_name || l.material_code}: ${l.qty} ${l.unit} (${euro(l.cost)})</li>`).join('')}
    </ul>
    <div class="mt-2 font-medium">Summe: ${euro(r.data.total_cost||0)}</div>
  `;
};

document.getElementById('logoutBtn').onclick = async ()=>{
  await fetch('/api/logout',{method:'POST'});
  location.href = '/login.html';
};

document.getElementById('search').addEventListener('input', loadLists);
['yieldQty','yieldUnit'].forEach(id=>{
  document.getElementById(id).addEventListener('change', recomputeCosts);
});

(async () => {
  await guard();
  await loadLists();
  // open first item by default
  const first = document.querySelector('#itemList li');
  if (first) first.click();
})();
</script>
</body>
</html>
