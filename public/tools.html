<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BUNCA â€” Tools</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
</head>
<body>
<header class="header">
  <nav class="nav">
    <div class="brand">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M4 12c0-4.418 3.582-8 8-8a8 8 0 1 1-8 8Z" stroke="currentColor" opacity=".8"/><path d="M12 4v16M4 12h16" stroke="currentColor" opacity=".6"/></svg>
      BUNCA Planner
    </div>
    <div class="tabs">
      <a class="tab" data-tab="tools" href="/tools.html">Tools</a>
      <a class="tab" data-tab="plan" href="/plan.html">Plan</a>
      <a class="tab" data-tab="items" href="/items.html">Rezepte</a>
      <a class="tab" data-tab="materials" href="/materials.html">Rohwaren</a>
      <a class="tab" data-tab="dash" href="/dashboard.html">Ãœbersicht</a>
    </div>
    <div class="right header-controls">
      <div class="accent"><div class="dot"></div><input id="accentPicker" type="color" style="background:transparent;border:none;width:20px;height:20px; padding:0"/></div>
      <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>
      <button class="density-toggle" onclick="toggleDensity()">â†•ï¸Ž</button>
      <button id="logout" class="btn">Logout</button>
    </div>
  </nav>
</header>

<div class="container">
  <div class="grid">
    <div class="card">
      <h3>Export</h3>
      <p class="muted"><small>CSV, JSON oder Excel (XLSX).</small></p>
      <div class="row">
        <select id="ds" class="input w150"><option>materials</option><option>items</option><option>bom</option><option>plan</option></select>
        <select id="fmt" class="input w120"><option>json</option><option>csv</option><option>xlsx</option></select>
        <input id="week" class="input w150" type="date" placeholder="Woche (nur fÃ¼r plan)">
        <button id="exportBtn" class="btn primary">Download</button>
      </div>
    </div>

    <div class="card">
      <h3>Backup & Restore</h3>
      <div class="row">
        <button id="backupBtn" class="btn">Backup herunterladen</button>
        <input id="restoreFile" class="input" type="file" accept=".json">
        <button id="restoreBtn" class="btn primary adminOnly">Backup einspielen</button>
      </div>
      <p class="muted"><small>Restore ersetzt Materialien, Items, BOM, Plan. Nur Admin.</small></p>
    </div>

    <div class="card adminOnly">
      <h3>Nutzer verwalten (Admin)</h3>
      <div class="row">
        <input id="uEmail" class="input w150" placeholder="email@example.com">
        <input id="uPass"  class="input w150" type="password" placeholder="Passwort">
        <select id="uRole" class="input w120"><option>viewer</option><option>planner</option><option>admin</option></select>
        <button id="uSave" class="btn primary">Speichern</button>
      </div>
      <div id="uList" class="muted" style="margin-top:8px">lÃ¤dtâ€¦</div>
    </div>
  </div>
</div>

<script>
navActive('tools');
$$('#accentPicker').addEventListener('input', (e)=> changeAccent(e.target.value));
document.getElementById('logout').onclick = async () => { await api('/api/logout', { method:'POST' }); location.href = '/login.html'; };

let ROLE = 'viewer';
(async () => { const u = await sessionInfo(); if (u) ROLE = u.role || 'viewer';
  if (ROLE !== 'admin') document.querySelectorAll('.adminOnly').forEach(el => el.style.display='none');
})();

document.getElementById('exportBtn').onclick = () => {
  const ds = $$('#ds').value, fmt = $$('#fmt').value, wk = $$('#week').value;
  window.location = `/api/tools/export/${encodeURIComponent(ds)}?format=${encodeURIComponent(fmt)}${wk?`&start=${encodeURIComponent(wk)}`:''}`;
};
document.getElementById('backupBtn').onclick = () => { window.location = '/api/tools/backup'; };
document.getElementById('restoreBtn').onclick = async () => {
  if (ROLE !== 'admin') return toast('Nur Admin darf Restore ausfÃ¼hren');
  const file = $$('#restoreFile').files?.[0]; if (!file) return toast('Bitte Backup-Datei wÃ¤hlen');
  try { const obj = JSON.parse(await file.text());
    await api('/api/tools/backup/restore', { method:'POST', body: JSON.stringify(obj) }); toast('Backup eingespielt');
  } catch(e){ toast('Restore fehlgeschlagen: '+e.message); }
};
async function loadUsers(){
  if (ROLE !== 'admin') { $$('#uList').textContent = 'Keine Admin-Rechte.'; return; }
  try {
    const { data } = await api('/api/users');
    $$('#uList').innerHTML = data.length
      ? data.map(u => `<div class="row"><div style="min-width:220px">${u.email}</div><div>${u.role}</div>
        <button data-email="${u.email}" class="btn">LÃ¶schen</button></div>`).join('')
      : '<div>Keine Nutzer</div>';
    document.querySelectorAll('#uList [data-email]').forEach(b => b.onclick = async () => {
      if (!confirm('Nutzer wirklich lÃ¶schen?')) return;
      try { await api('/api/users/' + encodeURIComponent(b.dataset.email), { method:'DELETE' }); loadUsers(); toast('GelÃ¶scht'); } catch(e){ toast('Fehler: '+e.message); }
    });
  } catch(e){ $$('#uList').textContent = 'Fehler: '+e.message; }
}
document.getElementById('uSave').onclick = async () => {
  if (ROLE !== 'admin') return toast('Nur Admin darf Nutzer speichern');
  try {
    await api('/api/users', { method:'POST', body: JSON.stringify({
      email: $$('#uEmail').value.trim(), password: $$('#uPass').value, role: $$('#uRole').value
    })}); toast('Nutzer gespeichert'); loadUsers();
  } catch(e){ toast('Fehler: '+e.message); }
};
loadUsers();
</script>
</body>
</html>
