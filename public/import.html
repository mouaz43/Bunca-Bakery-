<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BUNCA — Import</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
  <!-- CSV + Excel parsers -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<header class="header">
  <nav class="nav">
    <div style="font-weight:800">BUNCA Planner</div>
    <div class="tabs">
      <a class="tab" data-tab="import" href="/import.html">Import</a>
      <a class="tab" data-tab="dash" href="/dashboard.html">Übersicht</a>
    </div>
    <div><button id="logout" class="btn">Logout</button></div>
  </nav>
</header>

<div class="container">
  <div class="card">
    <h2>Import</h2>
    <p class="muted">Unterstützt: CSV / Excel (.xlsx) / JSON</p>
    <div class="grid">
      <div>
        <label>Datensatz</label><br/>
        <select id="dataset" class="input">
          <option value="materials">materials (Rohwaren)</option>
          <option value="items">items (Artikel)</option>
          <option value="bom">bom (Rezepturen)</option>
          <option value="plan">plan (Produktionsplan)</option>
        </select>
      </div>
      <div>
        <label>Datei</label><br/>
        <input id="file" type="file" class="input" accept=".csv,.json,.xlsx"/>
      </div>
      <div style="align-self:end">
        <button id="previewBtn" class="btn">Vorschau</button>
        <button id="saveBtn" class="btn primary">In DB speichern</button>
      </div>
    </div>
  </div>

  <div id="preview" class="card" style="display:none">
    <h3>Vorschau <span id="count" class="muted"></span></h3>
    <div style="overflow:auto">
      <table class="table">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
navActive('import');
document.getElementById('logout').onclick = async () => {
  await api('/api/logout', { method:'POST' });
  location.href = '/login.html';
};

const dsEl = document.getElementById('dataset');
const fileEl = document.getElementById('file');
const thead = document.getElementById('thead');
const tbody = document.getElementById('tbody');
const previewBox = document.getElementById('preview');
const countEl = document.getElementById('count');
let rows = [];

document.getElementById('previewBtn').addEventListener('click', async () => {
  const f = fileEl.files?.[0];
  if (!f) return toast('Bitte Datei wählen', false);
  try {
    rows = await parseFile(f);
    render(rows);
    toast('Vorschau bereit');
  } catch(e){ toast('Fehler: '+e.message, false); }
});

document.getElementById('saveBtn').addEventListener('click', async () => {
  if (!rows.length) return toast('Keine Daten geladen', false);
  try {
    const res = await api(`/api/import/${dsEl.value}`, {
      method:'POST',
      body: JSON.stringify(rows)
    });
    toast(`Gespeichert: ${res.inserted}`);
  } catch(e){ toast('Import fehlgeschlagen: '+e.message, false); }
});

function render(list){
  if (!list.length){ previewBox.style.display='none'; return; }
  const cols = Object.keys(list[0]);
  thead.innerHTML = '<tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr>';
  tbody.innerHTML = list.map(r => '<tr>' + cols.map(c=>`<td>${escapeHtml(r[c])}</td>`).join('') + '</tr>').join('');
  countEl.textContent = `(${list.length} Zeilen)`;
  previewBox.style.display='block';
}
function escapeHtml(x){ return String(x ?? '').replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }

async function parseFile(file){
  const ext = file.name.split('.').pop().toLowerCase();
  if (ext === 'csv'){
    const text = await file.text();
    const res = Papa.parse(text, { header:true });
    return cleanup(res.data);
  }
  if (ext === 'json'){
    const text = await file.text();
    const obj = JSON.parse(text);
    return Array.isArray(obj) ? cleanup(obj) : cleanup(obj.rows || obj.data || []);
  }
  if (ext === 'xlsx'){
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type:'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
    return cleanup(json);
  }
  throw new Error('Nicht unterstützter Typ'); 
}

function cleanup(arr){
  // Trim headers and values a bit
  return arr
    .filter(row => row && Object.values(row).some(v => String(v).trim() !== ''))
    .map(row => {
      const out = {};
      Object.keys(row).forEach(k => { out[String(k).trim()] = typeof row[k]==='string' ? row[k].trim() : row[k]; });
      return out;
    });
}
</script>
</body>
</html>
