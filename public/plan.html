<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bunca Bakeryflow — Produktionsplan</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
</head>
<body>
<header class="header">
  <nav class="nav">
    <div class="brand">Bunca Bakeryflow <small>Produktionsplan</small></div>
    <div class="menu">
      <button class="btn" onclick="location.href='/materials.html'">Rohwaren</button>
      <button class="btn" onclick="location.href='/items.html'">Rezepte</button>
      <button class="btn" onclick="location.href='/plan.html'">Produktionsplan</button>
      <button class="btn" onclick="location.href='/admin.html'">Admin</button>
      <button class="btn danger" onclick="logout()">Logout</button>
    </div>
  </nav>
</header>

<main class="container">
  <div class="card">
    <div class="card-head">
      <strong>Planung</strong>
      <div class="toolbar">
        <input id="day" type="date">
        <input id="code" type="text" placeholder="Rezept-Code">
        <input id="qty" type="number" step="0.001" placeholder="Menge">
        <input id="shop" type="text" placeholder="Filiale (optional)">
        <input id="note" type="text" placeholder="Notiz (optional)">
        <button class="btn primary" onclick="addRow()">Hinzufügen</button>
      </div>
    </div>
    <div class="card-body">
      <table class="table">
        <thead><tr><th>Datum</th><th>Rezept</th><th>Menge</th><th>Filiale</th><th>Status</th><th>Kosten/Stück</th><th>Summe</th><th></th></tr></thead>
        <tbody id="rows"><tr><td colspan="8"><div class="skeleton"></div></td></tr></tbody>
      </table>
    </div>
  </div>
</main>

<script>
let PLAN = [];

(async function init(){
  const user = await sessionInfo(); if(!user){ location.href='/login.html'; return; }
  document.getElementById('day').value = new Date().toISOString().slice(0,10);
  await loadPlan();
})();

async function loadPlan(){
  const d = document.getElementById('day').value;
  const res = await api('/api/plan?date='+encodeURIComponent(d)).catch(()=>({data:[]}));
  PLAN = Array.isArray(res)?res:(res.data||[]);
  render();
}

function render(){
  const body = document.getElementById('rows');
  if(!PLAN.length){ body.innerHTML = `<tr><td colspan="8" class="muted">Keine Einträge</td></tr>`; return; }
  body.innerHTML = PLAN.map(r=>{
    const date = esc((r.date||r.day||'').slice(0,10));
    const name = esc(r.recipe_name || r.product_name || r.recipe_code || r.product_code);
    const qty  = Number(r.quantity||r.qty||0);
    const unit = r.yield_unit || 'Stück';
    const unitCost = Number(r.unit_cost||r.unitCost||0);
    const total = Number(r.total_cost||0) || unitCost*qty;
    const st = (r.status||'planned').toLowerCase();
    const badgeClass = st==='completed'?'ok':st==='delayed'?'err':st==='in_progress'?'warn':'';
    return `
      <tr class="row">
        <td>${date}</td>
        <td>${name}</td>
        <td>${qty} ${esc(unit)}</td>
        <td>${esc(r.shop||'')}</td>
        <td><span class="badge ${badgeClass}">${esc(r.status||'planned')}</span></td>
        <td>${formatCurrency(unitCost)}</td>
        <td>${formatCurrency(total)}</td>
        <td class="row right">
          <button class="btn" onclick='editRow(${r.id})'>Bearbeiten</button>
          <button class="btn danger" onclick='removeRow(${r.id})'>Löschen</button>
        </td>
      </tr>
    `;
  }).join('');
}

async function addRow(){
  const d = val('day'), code = val('code'), qty = Number(val('qty'));
  const shop = val('shop'), note = val('note');
  if(!d || !code || !qty){ return toast('Datum, Code und Menge sind erforderlich','warning'); }
  try{
    await api('/api/plan',{method:'POST', body:{day:d, date:d, product_code:code, recipe_code:code, qty, quantity:qty, shop, note}});
    toast('Eintrag angelegt','success'); await loadPlan();
  }catch(e){ console.error(e); toast('Speichern fehlgeschlagen','error'); }
}

async function editRow(id){
  const row = PLAN.find(x=>x.id===id); if(!row) return;
  const qty = prompt('Neue Menge', Number(row.quantity||row.qty||0));
  if(qty===null) return;
  const d = (row.date||row.day||'').slice(0,10);
  try{
    await api('/api/plan/'+id,{method:'PUT', body:{
      date:d, recipe_code:row.recipe_code||row.product_code, quantity:Number(qty),
      shop:row.shop||'', status:row.status||'planned', note:row.note||''
    }});
    toast('Gespeichert','success'); await loadPlan();
  }catch(e){ console.error(e); toast('Speichern fehlgeschlagen','error'); }
}

async function removeRow(id){
  if(!confirm('Wirklich löschen?')) return;
  try{ await api('/api/plan/'+id,{method:'DELETE'}); toast('Gelöscht','info'); await loadPlan(); }
  catch(e){ console.error(e); toast('Löschen fehlgeschlagen','error'); }
}

/* utils */
function val(id){ return document.getElementById(id).value.trim(); }
function esc(s){return String(s??'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}
function formatCurrency(n,c='EUR'){ return new Intl.NumberFormat('de-DE',{style:'currency',currency:c}).format(Number(n||0)); }
</script>
</body>
</html>
