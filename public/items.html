<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bunca Bakeryflow — Rezepte</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
</head>
<body>
<header class="header">
  <nav class="nav">
    <div class="brand">Bunca Bakeryflow <small>Rezepte</small></div>
    <div class="menu">
      <button class="btn" onclick="location.href='/materials.html'">Rohwaren</button>
      <button class="btn" onclick="location.href='/items.html'">Rezepte</button>
      <button class="btn" onclick="location.href='/plan.html'">Produktionsplan</button>
      <button class="btn" onclick="location.href='/admin.html'">Admin</button>
      <button class="btn danger" onclick="logout()">Logout</button>
    </div>
  </nav>
</header>

<main class="container">
  <div class="card">
    <div class="card-head">
      <div class="row">
        <strong>Rezepte</strong> <span id="rcount" class="badge">0</span>
      </div>
      <div class="toolbar">
        <input id="q" class="search" type="text" placeholder="Suchen nach Name oder Code">
        <button class="btn primary" onclick="openRecipeModal()">Neu</button>
      </div>
    </div>
    <div class="card-body">
      <table class="table">
        <thead>
          <tr><th>Code</th><th>Name</th><th>Ergiebigkeit</th><th>Kategorie</th><th>Kosten/Stück</th><th></th></tr>
        </thead>
        <tbody id="list"><tr><td colspan="6"><div class="skeleton"></div></td></tr></tbody>
      </table>
    </div>
  </div>
</main>

<div id="modalHost"></div>

<script>
let RECIPES = [];

(async function init(){
  const user = await sessionInfo(); if(!user){ location.href='/login.html'; return; }
  await loadRecipes();
  document.getElementById('q').addEventListener('input', render);
})();

async function loadRecipes(){
  try{
    const r = await api('/api/recipes');
    RECIPES = Array.isArray(r) ? r : (r.data||[]);
    render();
  }catch(e){ console.error(e); toast('Fehler beim Laden der Rezepte','error'); }
}

function render(){
  const q = document.getElementById('q').value.toLowerCase();
  const rows = RECIPES.filter(r => !q || r.name.toLowerCase().includes(q) || r.code.toLowerCase().includes(q));
  document.getElementById('rcount').textContent = rows.length;
  if(!rows.length){ document.getElementById('list').innerHTML = `<tr><td colspan="6" class="muted">Keine Einträge</td></tr>`; return; }
  document.getElementById('list').innerHTML = rows.map(r=>`
    <tr class="row">
      <td>${esc(r.code)}</td>
      <td>${esc(r.name)}</td>
      <td>${Number(r.yield_qty||0)} ${esc(r.yield_unit||'pcs')}</td>
      <td>${esc(r.category||'')}</td>
      <td>${formatCurrency(r.unitCost ?? r.unit_cost ?? 0)}</td>
      <td class="row right">
        <button class="btn" onclick='openRecipeModal(${JSON.stringify(r)})'>Bearbeiten</button>
        <button class="btn danger" onclick='deleteRecipe("${r.code}")'>Löschen</button>
      </td>
    </tr>
  `).join('');
}

function openRecipeModal(data){
  const isEdit = !!data;
  // fetch ingredients if edit
  const loadIngredients = isEdit ? api(`/api/recipes/${encodeURIComponent(data.code)}/ingredients`).catch(()=>[]) : Promise.resolve([]);
  loadIngredients.then(ings => {
    const host = document.getElementById('modalHost');
    host.innerHTML = `
      <div class="modal-wrap" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
          <div class="head">${isEdit?'Rezept bearbeiten':'Rezept anlegen'}</div>
          <div class="body">
            <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
              <div><label>Code</label><input id="r-code" type="text" ${isEdit?'disabled':''} value="${isEdit?escAttr(data.code):''}"></div>
              <div><label>Name</label><input id="r-name" type="text" value="${isEdit?escAttr(data.name):''}"></div>
              <div><label>Ergiebigkeit (Menge)</label><input id="r-yqty" type="number" step="0.001" value="${isEdit?Number(data.yield_qty||1):1}"></div>
              <div><label>Ergiebigkeit (Einheit)</label><input id="r-yunit" type="text" value="${isEdit?escAttr(data.yield_unit||'pcs'):'pcs'}"></div>
              <div style="grid-column:1/-1"><label>Kategorie</label><input id="r-cat" type="text" value="${isEdit?escAttr(data.category||'bakery'):'bakery'}"></div>
            </div>

            <div class="hr"></div>
            <strong>Zutaten</strong>
            <div id="ingList" class="grid" style="grid-template-columns:1fr 100px 120px 100px;gap:8px;margin-top:10px"></div>
            <div class="row" style="margin-top:8px">
              <button class="btn" onclick="addIngRow()">Zutat hinzufügen</button>
              <span class="muted">Felder: Rohwaren-Code, Menge, Einheit, Ausschussfaktor</span>
            </div>
          </div>
          <div class="foot">
            <button class="btn" onclick="closeRecipeModal()">Abbrechen</button>
            <button class="btn primary" onclick="${isEdit?'saveRecipeEdit()':'saveRecipeCreate()'}">${isEdit?'Speichern':'Anlegen'}</button>
          </div>
        </div>
      </div>`;
    // initial rows
    (Array.isArray(ings)?ings:[]).forEach(i => addIngRow({product_code:i.product_code||i.productId, amount:i.amount||i.qty, unit:i.unit||'', waste_factor:i.waste_factor||0}));
    if(!isEdit) addIngRow(); // start with one row
    if(isEdit){
      document.getElementById('r-code').value = data.code;
      document.getElementById('r-name').value = data.name;
    }
  });
}
function closeRecipeModal(){ document.getElementById('modalHost').innerHTML=''; }
function closeModal(ev){ if(ev.target.classList.contains('modal-wrap')) closeRecipeModal(); }

function addIngRow(v={}){
  const root = document.getElementById('ingList');
  const id = 'ing_'+Math.random().toString(36).slice(2,7);
  const row = document.createElement('div');
  row.className='row'; row.style.gridColumn='1/-1'; row.dataset.id=id;
  row.innerHTML = `
    <input class="ing-code" type="text" placeholder="Code" value="${v.product_code||''}">
    <input class="ing-amt" type="number" step="0.0001" placeholder="Menge" value="${v.amount||0}">
    <input class="ing-unit" type="text" placeholder="Einheit" value="${v.unit||''}">
    <input class="ing-waste" type="number" step="0.0001" placeholder="Ausschuss" value="${v.waste_factor||0}">
    <button class="btn" onclick="this.parentElement.remove()">Entfernen</button>
  `;
  root.appendChild(row);
}

function readRecipeForm(){
  const code = document.getElementById('r-code').value.trim();
  const name = document.getElementById('r-name').value.trim();
  const yield_qty = Number(document.getElementById('r-yqty').value||1);
  const yield_unit = document.getElementById('r-yunit').value.trim()||'pcs';
  const category = document.getElementById('r-cat').value.trim()||'bakery';

  const ings = Array.from(document.querySelectorAll('#ingList .row')).map(r=>({
    productId: r.querySelector('.ing-code').value.trim(),
    amount: Number(r.querySelector('.ing-amt').value||0),
    unit: r.querySelector('.ing-unit').value.trim(),
    waste_factor: Number(r.querySelector('.ing-waste').value||0)
  })).filter(x=>x.productId);

  return { code, name, yield_qty, yield_unit, category, ingredientsJson: JSON.stringify(ings) };
}

async function saveRecipeCreate(){
  try{
    const p = readRecipeForm();
    await api('/api/recipes',{method:'POST', body:p});
    toast('Rezept angelegt','success');
    closeRecipeModal(); await loadRecipes();
  }catch(e){ console.error(e); toast('Speichern fehlgeschlagen','error'); }
}
async function saveRecipeEdit(){
  try{
    const p = readRecipeForm();
    await api('/api/recipes/'+encodeURIComponent(p.code),{method:'PUT', body:p});
    toast('Rezept gespeichert','success');
    closeRecipeModal(); await loadRecipes();
  }catch(e){ console.error(e); toast('Speichern fehlgeschlagen','error'); }
}

async function deleteRecipe(code){
  if(!confirm('Wirklich löschen?')) return;
  try{
    await api('/api/recipes/'+encodeURIComponent(code),{method:'DELETE'});
    toast('Gelöscht','info'); await loadRecipes();
  }catch(e){ console.error(e); toast('Löschen fehlgeschlagen','error'); }
}

/* utils */
function esc(s){return String(s??'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}
function escAttr(s){return esc(s).replace(/"/g,'&quot;');}
function formatCurrency(n,c='EUR'){ return new Intl.NumberFormat('de-DE',{style:'currency',currency:c}).format(Number(n||0)); }
</script>
</body>
</html>
