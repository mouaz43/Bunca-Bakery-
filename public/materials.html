<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bakeflow — Rohwaren</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
</head>
<body data-active="materials">
<div id="appHeader"></div>

<div class="container">
  <div class="card">
    <div class="row">
      <h2 style="margin-right:auto">Rohwaren</h2>
      <input id="filter" class="input w180" placeholder="Suchen…"/>
      <button id="addRow" class="btn">+ Neu</button>
      <button id="reload" class="btn">Neu laden</button>
    </div>

    <div style="overflow:auto">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Code</th>
            <th class="th-sort">Name</th>
            <th>Base</th>
            <th>Pack (Qty/Unit/€)</th>
            <th class="th-sort">€/base-unit</th>
            <th>Supplier</th>
            <th>Note</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- History modal -->
<div id="histModal" class="kbar" style="display:none">
  <div class="panel">
    <h3 style="margin:8px">Preisverlauf: <span id="histTitle"></span></h3>
    <div style="max-height:260px;overflow:auto">
      <table class="table"><thead><tr><th>Preis</th><th>Datum</th></tr></thead><tbody id="histBody"></tbody></table>
    </div>
    <div class="row right" style="margin-top:10px"><button id="histClose" class="btn">Schließen</button></div>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const bodyEl = document.getElementById('body');
  const reloadBtn = document.getElementById('reload');
  const addRowBtn = document.getElementById('addRow');
  const filterEl = document.getElementById('filter');

  const histModal = document.getElementById('histModal');
  const histTitle = document.getElementById('histTitle');
  const histBody  = document.getElementById('histBody');
  const histClose = document.getElementById('histClose');

  const T = (t,a={},...k)=>{const el=document.createElement(t);Object.entries(a).forEach(([k2,v])=>el.setAttribute(k2,v));k.forEach(x=>el.append(x));return el;};
  const td=(c)=>{const x=document.createElement('td');x.append(c);return x;};
  const num=(v)=>{const n=Number(String(v??'').replace(',','.'));return Number.isFinite(n)?n:null;};

  function computePPU(baseUnit, packQty, packUnit, packPrice){
    baseUnit = String(baseUnit||'g').toLowerCase();
    packUnit = String(packUnit||'').toLowerCase();
    const fam = { g:'g', kg:'g', ml:'ml', l:'ml', pcs:'pcs', piece:'pcs', pieces:'pcs', stk:'pcs', 'stück':'pcs' };
    const toBase = { g:1, kg:1000, ml:1, l:1000, pcs:1, piece:1, pieces:1, stk:1, 'stück':1 };
    if (packQty==null || packPrice==null || !fam[packUnit]) return null;
    if (fam[packUnit] !== fam[baseUnit]) return null;
    const baseQty = num(packQty) * toBase[packUnit];
    if (!baseQty || baseQty <= 0) return null;
    return num(packPrice) / baseQty;
  }

  async function load(){
    bodyEl.innerHTML = '<tr><td colspan="8" class="muted">Lade…</td></tr>';
    try {
      const { data } = await api('/api/materials');
      bodyEl.innerHTML = '';
      data.forEach(addRow);
    } catch (e) {
      console.error(e);
      bodyEl.innerHTML = `<tr><td colspan="8" class="muted">Fehler: ${e.message}</td></tr>`;
    }
    makeTableSortable(document.getElementById('tbl'));
    attachClientFilter(filterEl, document.getElementById('tbl'));
  }

  function addRow(r={}){
    const tr = document.createElement('tr');

    const code = T('input',{class:'input w120', value:r.code||''});
    const name = T('input',{class:'input w150', value:r.name||''});

    const base = T('select',{class:'input w80'},
      T('option',{},'g'), T('option',{},'kg'), T('option',{},'ml'), T('option',{},'l'), T('option',{},'pcs')
    );
    base.value = (r.base_unit||'g');

    // Pack group: qty / unit / price
    const packWrap = document.createElement('div');
    packWrap.className = 'row';
    const pQty   = T('input',{class:'input w70',  placeholder:'Qty',   value: r.pack_qty??''});
    const pUnit  = T('select',{class:'input w80'},
      T('option',{},'g'), T('option',{},'kg'), T('option',{},'ml'), T('option',{},'l'), T('option',{},'pcs')
    );
    pUnit.value = (r.pack_unit||'g');
    const pPrice = T('input',{class:'input w80',  placeholder:'€', value: r.pack_price??''});
    packWrap.append(pQty, pUnit, pPrice);

    // Read-only PPU
    const ppu = T('input',{class:'input w80', value:r.price_per_unit??'', readOnly:true});

    const supplier = T('input',{class:'input w120', value:r.supplier_code??''});
    const note     = T('input',{class:'input w150', value:r.note??''});

    function refreshPPU(){
      const v = computePPU(base.value, num(pQty.value), pUnit.value, num(pPrice.value));
      ppu.value = (v==null || !isFinite(v)) ? '' : String(v);
    }
    [base,pQty,pUnit,pPrice].forEach(el => el.addEventListener('input', refreshPPU));
    refreshPPU();

    const saveBtn = T('button',{class:'btn primary'},'Speichern');
    saveBtn.onclick = async () => {
      const payload = {
        code: code.value.trim(),
        name: name.value.trim(),
        base_unit: base.value,
        pack_qty: num(pQty.value),
        pack_unit: pUnit.value,
        pack_price: num(pPrice.value),
        // price_per_unit omitted → backend derives and tracks history
        supplier_code: supplier.value.trim() || null,
        note: note.value.trim()
      };
      if (!payload.code || !payload.name) return toast('Code & Name erforderlich');
      try { await api('/api/materials',{method:'POST', body: JSON.stringify(payload)}); toast('Gespeichert'); }
      catch(e){ console.error(e); toast('Fehler: '+e.message); }
    };

    const delBtn = T('button',{class:'btn'},'Löschen');
    delBtn.onclick = async () => {
      const c = code.value.trim();
      if (!c) return;
      if (!confirm(`Rohware “${c}” wirklich löschen?`)) return;
      try { await api('/api/materials/' + encodeURIComponent(c), { method:'DELETE' }); tr.remove(); toast('Gelöscht'); }
      catch(e){ toast(e.message.includes('in_use_in_bom') ? 'In Rezepten benutzt — erst dort entfernen' : 'Löschen fehlgeschlagen'); }
    };

    const histBtn = T('button',{class:'btn'},'Verlauf');
    histBtn.onclick = () => openHistory(code.value.trim());

    const actions = document.createElement('div');
    actions.className = 'row';
    actions.append(saveBtn, delBtn, histBtn);

    tr.append(td(code), td(name), td(base), td(packWrap), td(ppu), td(supplier), td(note), td(actions));
    bodyEl.append(tr);
  }

  async function openHistory(code){
    if (!code) return toast('Kein Code');
    histTitle.textContent = code;
    histBody.innerHTML = '<tr><td colspan="2" class="muted">Lade…</td></tr>';
    histModal.style.display = 'flex';
    try {
      const { data } = await api(`/api/materials/${encodeURIComponent(code)}/history`);
      histBody.innerHTML = data.length
        ? data.map(x => `<tr><td>${x.price_per_unit}</td><td>${new Date(x.changed_at).toLocaleString()}</td></tr>`).join('')
        : '<tr><td colspan="2" class="muted">Keine Einträge</td></tr>';
    } catch (e) {
      histBody.innerHTML = '<tr><td colspan="2" class="muted">Fehler beim Laden</td></tr>';
    }
  }
  histClose.addEventListener('click', () => histModal.style.display='none');

  reloadBtn.addEventListener('click', load);
  addRowBtn.addEventListener('click', () => addRow({ base_unit:'g', pack_unit:'g' }));
  load();
});
</script>
</body>
</html>
