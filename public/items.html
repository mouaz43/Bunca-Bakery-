<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bakeflow ‚Äî Artikel & Rezepte</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
</head>
<body>
<header class="header">
  <nav class="nav">
    <div class="brand">üçû Bakeflow</div>
    <div class="right header-controls">
      <input id="q" class="input" placeholder="Suchen‚Ä¶"/>
      <button class="btn" onclick="location.href='/materials.html'">Rohwaren</button>
      <button class="btn" onclick="location.href='/plan.html'">Plan</button>
      <button class="btn danger" onclick="logout()">Logout</button>
    </div>
  </nav>
</header>

<main class="container">
  <div class="card">
    <div class="card-title-row">
      <h2>Artikel & Rezepte</h2>
      <div class="row-gap">
        <button class="btn primary" id="addItem">+ Neuer Artikel</button>
        <button class="btn" id="reload">Neu laden</button>
      </div>
    </div>

    <div class="table-wrap">
      <table id="tbl" class="table">
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Kategorie</th>
            <th>Yield Qty</th>
            <th>Yield Unit</th>
            <th>Notiz</th>
            <th style="width:200px">Aktionen</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="7" class="muted">Lade‚Ä¶</td></tr></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Item Modal -->
<div id="itemModal" class="modal hidden">
  <div class="modal-card" style="max-width:620px">
    <div class="modal-head">
      <h3 id="itemTitle">Artikel</h3>
      <button class="btn subtle" onclick="closeItem()">Schlie√üen</button>
    </div>
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px">
      <div><label>Code</label><input id="i_code" class="input"/></div>
      <div><label>Name</label><input id="i_name" class="input"/></div>
      <div><label>Kategorie</label><input id="i_cat" class="input"/></div>
      <div><label>Yield Qty</label><input id="i_yqty" type="number" step="0.01" class="input" value="1"/></div>
      <div><label>Yield Unit</label><input id="i_yunit" class="input" value="pcs"/></div>
      <div style="grid-column:1/-1"><label>Notiz</label><input id="i_note" class="input"/></div>
    </div>
    <div class="modal-foot">
      <div class="spacer"></div>
      <button class="btn primary" id="saveItem">Speichern</button>
    </div>
  </div>
</div>

<!-- Recipe Modal -->
<div id="recipeModal" class="modal hidden">
  <div class="modal-card" style="max-width:900px">
    <div class="modal-head">
      <h3 id="recipeTitle">Rezept</h3>
      <div class="row-gap">
        <div style="display:flex;gap:8px;align-items:center">
          <label class="muted">Menge</label>
          <input id="r_qty" class="input" type="number" step="0.01" style="width:120px" value="1"/>
          <span id="r_yield" class="muted"></span>
        </div>
        <button class="btn" id="calcCost">Kosten</button>
        <button class="btn primary" id="saveRecipe">Speichern</button>
        <button class="btn subtle" onclick="closeRecipe()">Schlie√üen</button>
      </div>
    </div>

    <div class="card" style="padding:12px;margin-bottom:12px">
      <div class="row-gap" style="align-items:center; gap:10px">
        <button class="btn" id="addLine">+ Zutat</button>
        <div class="muted">Schnellsuche Rohwaren:</div>
        <input id="searchMat" class="input" placeholder="Tippen, z. B. Zucker‚Ä¶" style="min-width:260px"/>
        <div id="acWrap" class="dropdown hidden"></div>
      </div>
    </div>

    <div class="table-wrap">
      <table class="table" id="bomTbl">
        <thead>
          <tr>
            <th style="width:28%">Material</th>
            <th style="width:18%">Menge</th>
            <th style="width:14%">Einheit</th>
            <th style="width:16%">‚Ç¨/base</th>
            <th style="width:16%">Zeilenkosten</th>
            <th style="width:8%"></th>
          </tr>
        </thead>
        <tbody id="bomRows">
          <tr><td colspan="6" class="muted">Noch kein Rezept</td></tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4" class="right muted">Summe</td>
            <td id="sumCost" class="right bold">0.00</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<script>
function logout(){ api('/api/logout',{method:'POST'}).then(()=>location.href='/login.html'); }

/* ---------- State ---------- */
let ITEMS=[], UNITS=[], CURRENT_ITEM=null, BOM=[]; // BOM: {material_code, material_name, qty, unit, ppu, cost}

/* ---------- Load ---------- */
async function loadUnits(){ const r=await api('/api/units'); UNITS=r.data.units; }
async function load(){
  const r = await api('/api/items'); ITEMS = r.data || [];
  render(ITEMS);
}
function render(list){
  const tbody = $$('#rows');
  if (!list.length){ tbody.innerHTML = `<tr><td colspan="7" class="muted">Noch keine Artikel</td></tr>`; return; }
  tbody.innerHTML = list.map(it => `
    <tr>
      <td>${it.code}</td>
      <td>${it.name}</td>
      <td>${it.category||''}</td>
      <td>${it.yield_qty}</td>
      <td>${it.yield_unit}</td>
      <td>${it.note||''}</td>
      <td class="row-actions">
        <button class="btn subtle" data-rez="${it.code}">Rezept</button>
        <button class="btn subtle" data-edit="${it.code}">Bearb.</button>
        <button class="btn danger" data-del="${it.code}">L√∂schen</button>
      </td>
    </tr>
  `).join('');
  makeTableSortable($$('#tbl'));
}
attachClientFilter($$('#q'), $$('#tbl'));

/* ---------- Item modal ---------- */
function openItem(title){ $$('#itemTitle').textContent=title; $$('#itemModal').classList.remove('hidden'); }
function closeItem(){ $$('#itemModal').classList.add('hidden'); }
function fillItem(it){
  $$('#i_code').value = it?.code||'';
  $$('#i_name').value = it?.name||'';
  $$('#i_cat').value  = it?.category||'';
  $$('#i_yqty').value = it?.yield_qty||1;
  $$('#i_yunit').value= it?.yield_unit||'pcs';
  $$('#i_note').value = it?.note||'';
}
function readItem(){ return {
  code: $$('#i_code').value.trim(),
  name: $$('#i_name').value.trim(),
  category: $$('#i_cat').value.trim(),
  yield_qty: Number($$('#i_yqty').value||1),
  yield_unit: $$('#i_yunit').value.trim()||'pcs',
  note: $$('#i_note').value.trim()
};}

$$('#addItem').addEventListener('click', ()=>{
  CURRENT_ITEM=null; fillItem(null); openItem('Neuer Artikel'); $$('#i_code').focus();
});
$$('#saveItem').addEventListener('click', async ()=>{
  const payload = readItem();
  if(!payload.code||!payload.name){ toast('Code & Name erforderlich'); return; }
  try{ await api('/api/items',{method:'POST', body:JSON.stringify(payload)}); closeItem(); await load(); toast('Gespeichert'); }
  catch(e){ toast(e.message||'Fehler'); }
});

/* ---------- Recipe modal ---------- */
function openRecipe(title){ $$('#recipeTitle').textContent=title; $$('#recipeModal').classList.remove('hidden'); }
function closeRecipe(){ $$('#recipeModal').classList.add('hidden'); BOM=[]; renderBOM(); }
function renderBOM(){
  const tb = $$('#bomRows');
  if (!BOM.length){ tb.innerHTML = `<tr><td colspan="6" class="muted">Noch kein Rezept</td></tr>`; $$('#sumCost').textContent='0.00'; return; }
  tb.innerHTML = BOM.map((l,idx)=>`
    <tr>
      <td>
        <div class="mono small muted">${l.material_code}</div>
        <div>${l.material_name||''}</div>
      </td>
      <td><input class="input" type="number" step="0.01" value="${l.qty||''}" data-q="${idx}"/></td>
      <td>
        <select class="input" data-u="${idx}">
          ${['g','kg','ml','l','pcs'].map(u=>`<option ${l.unit===u?'selected':''} value="${u}">${u}</option>`).join('')}
        </select>
      </td>
      <td class="right">${(l.ppu??0).toFixed(6)}</td>
      <td class="right">${(l.cost??0).toFixed(2)}</td>
      <td class="right"><button class="btn danger" data-x="${idx}">x</button></td>
    </tr>
  `).join('');
  const sum = BOM.reduce((s,x)=>s+Number(x.cost||0),0);
  $$('#sumCost').textContent = sum.toFixed(2);
}
async function loadBOM(code){
  const r = await api(`/api/items/${encodeURIComponent(code)}/bom`);
  BOM = (r.data||[]).map(x=>({ material_code:x.material_code, material_name:x.material_name, qty:Number(x.qty), unit:x.unit, ppu:0, cost:0 }));
  // pre-calc costs for current yield quantity
  await Promise.all(BOM.map(async (L,idx)=>{ const c = await calcLine(L.material_code, L.qty, L.unit); BOM[idx].ppu=c.price_per_unit; BOM[idx].cost=c.cost; }));
  renderBOM();
}
async function calcLine(material_code, qty, unit){
  const r = await api('/api/calc/line', { method:'POST', body:JSON.stringify({ material_code, qty:Number(qty||0), unit }) });
  return r.data; // {unit, qty, price_per_unit, cost, material_name}
}

/* Autocomplete for Rohwaren */
let acTimer=null;
$$('#searchMat').addEventListener('input', async (e)=>{
  clearTimeout(acTimer);
  const q = e.target.value.trim();
  if (!q){ $$('#acWrap').classList.add('hidden'); $$('#acWrap').innerHTML=''; return; }
  acTimer = setTimeout(async ()=>{
    const r = await api(`/api/materials/search?q=${encodeURIComponent(q)}`);
    const list = r.data||[];
    if (!list.length){ $$('#acWrap').classList.add('hidden'); $$('#acWrap').innerHTML=''; return; }
    $$('#acWrap').classList.remove('hidden');
    $$('#acWrap').innerHTML = list.map(m=>`
      <div class="dropdown-item" data-code="${m.code}" data-name="${m.name}" data-base="${m.base_unit}" data-ppu="${m.price_per_unit}">
        <div class="bold">${m.name}</div>
        <div class="muted mono small">${m.code} ‚Äî ${m.base_unit} @ ${(m.price_per_unit||0).toFixed(6)} ‚Ç¨/base</div>
      </div>`).join('');
  }, 160);
});
$$('#acWrap').addEventListener('click', async (e)=>{
  const el = e.target.closest('.dropdown-item'); if (!el) return;
  const code = el.dataset.code, name = el.dataset.name;
  // push blank line with default unit from base family
  const base = el.dataset.base;
  const defaultUnit = base==='g' ? 'g' : base==='ml' ? 'ml' : 'pcs';
  const line = { material_code:code, material_name:name, qty:0, unit:defaultUnit, ppu:Number(el.dataset.ppu||0), cost:0 };
  BOM.push(line); renderBOM();
  $$('#acWrap').classList.add('hidden'); $$('#searchMat').value='';
});

/* events inside bom table */
$$('#bomRows').addEventListener('input', async (e)=>{
  const qIdx = e.target?.dataset?.q;
  const uIdx = e.target?.dataset?.u;
  if (qIdx!=null){
    const L = BOM[Number(qIdx)];
    L.qty = Number(e.target.value||0);
    const c = await calcLine(L.material_code, L.qty, L.unit);
    L.ppu = c.price_per_unit; L.cost = c.cost; renderBOM();
  }
  if (uIdx!=null){
    const L = BOM[Number(uIdx)];
    L.unit = e.target.value;
    const c = await calcLine(L.material_code, L.qty, L.unit);
    L.ppu = c.price_per_unit; L.cost = c.cost; renderBOM();
  }
});
$$('#bomRows').addEventListener('click', (e)=>{
  const idx = e.target?.dataset?.x;
  if (idx!=null){ BOM.splice(Number(idx),1); renderBOM(); }
});

/* buttons top of recipe modal */
$$('#addLine').addEventListener('click', ()=>{ 
  BOM.push({ material_code:'', material_name:'', qty:0, unit:'g', ppu:0, cost:0 }); renderBOM();
  toast('Nutze die Schnellsuche, um Material zu w√§hlen');
});
$$('#saveRecipe').addEventListener('click', async ()=>{
  // validate
  const cleaned = BOM.filter(l=>l.material_code && Number(l.qty)>0).map(({material_code,qty,unit})=>({material_code,qty:Number(qty),unit}));
  try{
    await api(`/api/items/${encodeURIComponent(CURRENT_ITEM.code)}/bom`, { method:'POST', body:JSON.stringify({ lines: cleaned }) });
    toast('Rezept gespeichert'); closeRecipe();
  }catch(e){ toast(e.message||'Fehler beim Speichern'); }
});
$$('#calcCost').addEventListener('click', async ()=>{
  const qty = Number($$('#r_qty').value||0);
  if (!qty) return toast('Menge eingeben');
  const r = await api(`/api/items/${encodeURIComponent(CURRENT_ITEM.code)}/bom/priced?qty=${qty}`);
  const priced = r.data.lines;
  // merge priced back into BOM view for quick feedback
  let sum=0;
  BOM = priced.map(p=>({ material_code:p.material_code, material_name:p.material_name, qty:p.qty, unit:p.unit, ppu:p.price_per_unit, cost:p.cost }));
  renderBOM();
});

/* ---------- table actions ---------- */
$$('#reload').addEventListener('click', load);
$$('#rows').addEventListener('click', async (e)=>{
  const cEdit = e.target?.dataset?.edit;
  const cDel  = e.target?.dataset?.del;
  const cRez  = e.target?.dataset?.rez;
  if (cEdit){
    const it = ITEMS.find(x=>x.code===cEdit); CURRENT_ITEM=it; fillItem(it); openItem('Artikel bearbeiten');
  }
  if (cDel){
    if (!confirm('Artikel wirklich l√∂schen?')) return;
    try{ await api(`/api/items/${encodeURIComponent(cDel)}`, { method:'DELETE' }); toast('Gel√∂scht'); load(); }
    catch(e){ toast('Fehler beim L√∂schen'); }
  }
  if (cRez){
    const it = ITEMS.find(x=>x.code===cRez); CURRENT_ITEM=it;
    $$('#r_yield').textContent = `= ${it.yield_qty} ${it.yield_unit}`;
    $$('#r_qty').value = it.yield_qty;
    openRecipe(`Rezept: ${it.code} ‚Äî ${it.name}`);
    await loadBOM(it.code);
  }
});

/* ---------- boot ---------- */
async function boot(){
  const u = await sessionInfo(); if(!u){ location.href='/login.html'; return; }
  await loadUnits();
  await load();
}
boot();
</script>

</body>
</html>
