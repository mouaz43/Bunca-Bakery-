<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bakeflow ‚Äî Rohwaren</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
  <style>
    .row-actions { display:flex; gap:8px; justify-content:flex-end }
    .pill { padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--border); font-size:12px }
    .small-note{ color:var(--text-muted); font-size:12px }
    .grid-top{ display:grid; gap:10px; grid-template-columns: 1fr auto auto }
    @media (max-width: 720px){ .grid-top{ grid-template-columns:1fr; } }
    .del{ background:rgba(255,0,0,.08); border-color:rgba(255,0,0,.25) }
    .tip-line{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .tight input, .tight select { padding:7px 8px; }
  </style>
</head>
<body>

<header class="header">
  <nav class="nav">
    <div class="brand">üçû Bakeflow ‚Äî Rohwaren</div>
    <div class="menu-wrap">
      <button class="btn" onclick="location.href='/dashboard.html'">Dashboard</button>
      <button class="btn" onclick="location.href='/items.html'">Rezepte</button>
      <button class="btn" onclick="location.href='/plan.html'">Plan</button>
      <button class="btn danger" onclick="logout()">Logout</button>
    </div>
  </nav>
</header>

<main class="container">
  <section class="card">
    <div class="card-title-row">
      <h2 style="margin:0">Rohwaren</h2>
      <div class="grid-top">
        <input id="search" class="input" placeholder="Suchen‚Ä¶ (Code / Name)"/>
        <button class="btn" id="newBtn">+ Neu</button>
        <button class="btn" id="reloadBtn">Neu laden</button>
      </div>
    </div>

    <div class="card-pad">
      <div class="tip-line small-note">
        <span class="pill">Tipp</span> Trage nur **Pack price** ein, der ‚Ç¨/base wird automatisch berechnet und gespeichert.
      </div>

      <div class="table-wrap" style="margin-top:10px">
        <table class="table tight" id="tbl">
          <thead>
            <tr>
              <th>Code</th>
              <th>Name</th>
              <th>Base</th>
              <th>Pack Qty</th>
              <th>Pack Unit</th>
              <th>Pack Price</th>
              <th>‚Ç¨/base</th>
              <th>Supplier</th>
              <th>Note</th>
              <th class="right">Aktionen</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="10" class="muted">Lade‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script>
function logout(){ api('/api/logout',{method:'POST'}).then(()=>location.href='/login.html'); }

const U = { g:1, kg:1000, ml:1, l:1000, pcs:1, piece:1, pieces:1, stk:1, 'st√ºck':1 };
function family(u){ u=(u||'').toLowerCase(); if (u==='g'||u==='kg') return 'g'; if (u==='ml'||u==='l') return 'ml'; if (u==='pcs'||u==='piece'||u==='pieces'||u==='stk'||u==='st√ºck') return 'pcs'; return u; }
function toBaseQty(qty, unit, base){ if (!qty || !unit || !base) return null; const f=family(unit), b=family(base); if (f!==b) return null; return Number(qty) * (U[unit.toLowerCase()]||1); }
function euroBase(pack_qty, pack_unit, pack_price, base_unit){
  const baseQty = toBaseQty(pack_qty, pack_unit, base_unit);
  if (!baseQty || !pack_price) return 0;
  return Number(pack_price) / Number(baseQty);
}

let DATA = [];

function rowHTML(m){
  const ppu = Number(m.price_per_unit||0);
  return `<tr data-code="${m.code}">
    <td><input class="input mono" value="${m.code||''}" data-k="code"/></td>
    <td><input class="input" value="${m.name||''}" data-k="name"/></td>
    <td>
      <select class="input" data-k="base_unit">
        ${['g','ml','pcs'].map(u=>`<option ${m.base_unit===u?'selected':''} value="${u}">${u}</option>`).join('')}
      </select>
    </td>
    <td><input class="input mono" type="number" step="0.01" value="${m.pack_qty??''}" data-k="pack_qty"/></td>
    <td>
      <select class="input" data-k="pack_unit">
        <option value=""></option>
        ${['g','kg','ml','l','pcs'].map(u=>`<option ${m.pack_unit===u?'selected':''} value="${u}">${u}</option>`).join('')}
      </select>
    </td>
    <td><input class="input mono" type="number" step="0.01" value="${m.pack_price??''}" data-k="pack_price"/></td>
    <td class="mono" data-k="ppu">${ppu ? ppu.toFixed(6) : ''}</td>
    <td><input class="input" value="${m.supplier_code||''}" data-k="supplier_code"/></td>
    <td><input class="input" value="${m.note||''}" data-k="note"/></td>
    <td class="right">
      <div class="row-actions">
        <button class="btn" onclick="saveRow(this)">Speichern</button>
        <button class="btn del" onclick="delRow('${m.code}')">L√∂schen</button>
      </div>
    </td>
  </tr>`;
}

async function load(){
  const r = await api('/api/materials');
  DATA = r.data || [];
  const tb = document.getElementById('tbody');
  tb.innerHTML = DATA.map(rowHTML).join('') || `<tr><td colspan="10" class="muted">Keine Eintr√§ge</td></tr>`;
  makeTableSortable(document.getElementById('tbl'));
}
function valuesOf(tr){
  const obj = {};
  $$$('input,select', tr).forEach(el=>{
    obj[el.dataset.k] = (el.type==='number' && el.value!=='') ? Number(el.value) : (el.value || null);
  });
  return obj;
}
async function saveRow(btn){
  const tr = btn.closest('tr');
  const v = valuesOf(tr);
  // auto-compute price_per_unit from pack if available
  const ppu = euroBase(v.pack_qty, v.pack_unit, v.pack_price, v.base_unit);
  const body = { ...v, price_per_unit: Number(ppu||0) };
  await api('/api/materials', { method:'POST', body: JSON.stringify(body) });
  tr.querySelector('[data-k="ppu"]').textContent = (ppu||0).toFixed(6);
  toast('Gespeichert');
}
async function delRow(code){
  if (!code) return;
  if (!confirm(`Rohware ${code} l√∂schen?`)) return;
  await api('/api/materials/'+encodeURIComponent(code), { method:'DELETE' });
  await load(); toast('Gel√∂scht');
}
function addNew(){
  const tb = document.getElementById('tbody');
  const tmp = {
    code:'', name:'', base_unit:'g',
    pack_qty:null, pack_unit:null, pack_price:null,
    price_per_unit:0, supplier_code:'', note:''
  };
  tb.insertAdjacentHTML('afterbegin', rowHTML(tmp));
}

document.getElementById('newBtn').addEventListener('click', addNew);
document.getElementById('reloadBtn').addEventListener('click', load);
// client filter
attachClientFilter(document.getElementById('search'), document.getElementById('tbl'));

(async function(){
  const u = await sessionInfo(); if(!u){ location.href='/login.html'; return; }
  await load();
})();
</script>

</body>
</html>
