<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bakeflow ‚Äî Diagnose</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
  <style>
    .hero{ max-width:900px; margin:24px auto; padding:0 16px }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:var(--card) }
    .ok{ color:#6fe3a6 } .bad{ color:#ff8a8a } .warn{ color:#ffb24f }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace }
    .log{ white-space:pre-wrap; font-size:12px; max-height:200px; overflow:auto; border:1px solid var(--border); border-radius:10px; padding:10px; background:rgba(255,255,255,.04) }
  </style>
</head>
<body>

<header class="header">
  <nav class="nav">
    <div class="brand">üçû Bakeflow ‚Äî Diagnose</div>
    <div class="menu-wrap">
      <button class="btn" onclick="location.href='/dashboard.html'">Dashboard</button>
      <button class="btn danger" onclick="logout()">Logout</button>
    </div>
  </nav>
</header>

<main class="hero">
  <section class="card">
    <div class="card-title-row">
      <div>
        <h2 style="margin:0">Systemchecks</h2>
        <div class="muted small">Schnelle Diagnose f√ºr Verbindungen & Session</div>
      </div>
      <div class="row-gap">
        <button class="btn" id="run">Neu pr√ºfen</button>
      </div>
    </div>

    <div class="card-pad">
      <div class="row"><div>Server /healthz</div><div id="sHealth">‚Äî</div></div>
      <div class="row"><div>Session</div><div id="sSession">‚Äî</div></div>
      <div class="row"><div>Rohwaren API</div><div id="sMaterials">‚Äî</div></div>
      <div class="row"><div>Artikel API</div><div id="sItems">‚Äî</div></div>
      <div class="row"><div>Plan heute</div><div id="sPlan">‚Äî</div></div>
      <div class="row"><div>Kalkulation</div><div id="sCalc">‚Äî</div></div>

      <hr class="sep"/>
      <div class="muted small">Protokoll</div>
      <div id="log" class="log mono">‚Äî</div>
    </div>
  </section>
</main>

<script>
function logout(){ api('/api/logout',{method:'POST'}).then(()=>location.href='/login.html'); }
function setEl(id, ok, text=''){
  const el = document.getElementById(id);
  el.className = ok ? 'ok' : 'bad';
  el.textContent = ok ? (text || 'OK') : (text || 'Fehler');
}
function log(msg){
  const el = document.getElementById('log');
  el.textContent = (el.textContent==='‚Äî' ? '' : el.textContent + '\n') + msg;
  el.scrollTop = el.scrollHeight;
}
function today(){ return new Date().toISOString().slice(0,10); }

async function run(){
  document.getElementById('log').textContent='‚Äî';
  // health
  try{
    const r = await fetch('/healthz'); const j = await r.json();
    setEl('sHealth', j.ok, j.ok ? 'OK' : 'NOK'); log('healthz: ' + JSON.stringify(j));
  }catch(e){ setEl('sHealth', false, 'Fehler'); log('healthz error: ' + e.message); }

  // session
  try{
    const j = await api('/api/session'); setEl('sSession', true, j.user ? 'angemeldet' : 'keine Session'); log('session: ' + JSON.stringify(j));
  }catch(e){ setEl('sSession', false, 'Fehler'); log('session error: ' + e.message); }

  // materials
  try{
    const j = await api('/api/materials'); setEl('sMaterials', true, j.data?.length + ' Eintr√§ge'); log('materials: ' + j.data.length);
  }catch(e){ setEl('sMaterials', false, 'Fehler'); log('materials error: ' + e.message); }

  // items
  try{
    const j = await api('/api/items'); setEl('sItems', true, j.data?.length + ' Eintr√§ge'); log('items: ' + j.data.length);
  }catch(e){ setEl('sItems', false, 'Fehler'); log('items error: ' + e.message); }

  // plan today
  try{
    const j = await api('/api/plan?date=' + today()); setEl('sPlan', true, j.data?.length + ' Eintr√§ge'); log('plan today: ' + j.data.length);
  }catch(e){ setEl('sPlan', false, 'Fehler'); log('plan error: ' + e.message); }

  // calc
  try{
    const j = await api('/api/plan/calc', { method:'POST', body: JSON.stringify({ rows: [] }) });
    setEl('sCalc', true, 'OK'); log('calc: ' + JSON.stringify(j.data||{}));
  }catch(e){ setEl('sCalc', false, 'Fehler'); log('calc error: ' + e.message); }
}

document.getElementById('run').addEventListener('click', run);

(async function(){
  const u = await sessionInfo(); if (!u) { /* still allow diagnostics */ }
  run();
})();
</script>

</body>
</html>
