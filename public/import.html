<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>BUNCA – Import</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for Excel parsing in the browser -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body class="min-h-screen bg-stone-50 text-stone-900">
<header class="bg-white border-b border-stone-200">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <a href="/" class="h-8 w-8 rounded-lg bg-emerald-600 block"></a>
      <h1 class="text-lg font-semibold tracking-tight">Import</h1>
    </div>
    <nav class="flex items-center gap-2 text-sm">
      <a href="/materials.html" class="px-3 py-1.5 rounded-lg hover:bg-stone-100">Rohwaren</a>
      <a href="/recipes.html" class="px-3 py-1.5 rounded-lg hover:bg-stone-100">Rezepte</a>
      <a href="/plan.html" class="px-3 py-1.5 rounded-lg hover:bg-stone-100">Plan</a>
      <button id="logoutBtn" class="ml-2 px-3 py-1.5 rounded-lg bg-stone-900 text-white hover:bg-stone-800">Logout</button>
    </nav>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
  <!-- Step 1: file -->
  <section class="bg-white rounded-2xl shadow p-4">
    <h2 class="font-semibold mb-3">1. Datei auswählen</h2>
    <input id="file" type="file" accept=".xlsx,.xls,.csv" class="block">
    <p class="text-xs text-stone-500 mt-2">Unterstützt Excel (.xlsx/.xls) und CSV. Für den Start importieren wir Rohwaren – Rezepte/BOM folgen.</p>
  </section>

  <!-- Step 2: sheet/preview -->
  <section class="bg-white rounded-2xl shadow p-4">
    <h2 class="font-semibold mb-3">2. Vorschau & Zuordnung</h2>
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-3">
      <div class="md:col-span-2">
        <label class="text-sm">Tabelle / Sheet</label>
        <select id="sheet" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2"></select>
      </div>
      <div>
        <label class="text-sm">Code</label>
        <select id="m_code" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2"></select>
      </div>
      <div>
        <label class="text-sm">Name</label>
        <select id="m_name" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2"></select>
      </div>
      <div>
        <label class="text-sm">Einheit</label>
        <select id="m_unit" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2"></select>
      </div>
      <div>
        <label class="text-sm">Preis/Einheit</label>
        <select id="m_price" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2"></select>
      </div>
      <div>
        <label class="text-sm">Lieferant (optional)</label>
        <select id="m_supplier" class="mt-1 w-full rounded-xl border border-stone-300 px-3 py-2"></select>
      </div>
    </div>

    <div class="overflow-x-auto border rounded-2xl">
      <table class="min-w-full text-sm">
        <thead class="bg-stone-50" id="th"></thead>
        <tbody id="tb" class="divide-y divide-stone-100"></tbody>
      </table>
    </div>

    <div class="mt-3 flex items-center gap-2">
      <button id="apply" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Import starten</button>
      <span id="msg" class="text-sm text-stone-600"></span>
    </div>
  </section>
</main>

<script>
async function guard(){ const s=await fetch('/api/session').then(r=>r.json()); if(!s.user) location.href='/login.html'; }
document.getElementById('logoutBtn').onclick = async ()=>{ await fetch('/api/logout',{method:'POST'}); location.href='/login.html'; };

let WB=null, SHEETNAMES=[], DATA_BY_SHEET={};

function guessHeader(name){
  const n=(name||'').toLowerCase();
  if(/code|artikel.*nr|sku|id/.test(n)) return 'code';
  if(/name|bezeichnung|produkt/.test(n)) return 'name';
  if(/einheit|unit/.test(n)) return 'unit';
  if(/preis|eur|€|price/.test(n)) return 'price';
  if(/lieferant|supplier/.test(n)) return 'supplier';
  return '';
}
function normalizeUnit(u){
  const s=String(u||'').trim().toLowerCase();
  if(['g','gram','gramm','grams','kg'].includes(s)) return s==='kg'?'g':'g';
  if(['ml','milliliter','l','liter'].includes(s)) return s==='l'?'ml':'ml';
  if(['stk','stück','stueck','pcs','piece','pieces','ea'].includes(s)) return 'pcs';
  return s||'g';
}
function parsePrice(v){
  if(v==null) return 0;
  let s=String(v).replace(/\s/g,'').replace('€','').replace(',','.');
  return Number(s)||0;
}

function renderPreview(sheetName){
  const rows=DATA_BY_SHEET[sheetName]||[];
  const head=rows[0]||[];
  const th=document.getElementById('th'); const tb=document.getElementById('tb');
  th.innerHTML='<tr>'+head.map(h=>`<th class="text-left px-3 py-2">${h}</th>`).join('')+'</tr>';
  tb.innerHTML='';
  for(let i=1;i<Math.min(rows.length,31);i++){
    const r=rows[i]||[];
    const tr=document.createElement('tr');
    tr.innerHTML=r.map(c=>`<td class="px-3 py-2">${c==null?'':c}</td>`).join('');
    tb.appendChild(tr);
  }
  // populate mapping selects
  const opts=head.map(h=>`<option value="${h}">${h}</option>`).join('');
  ['m_code','m_name','m_unit','m_price','m_supplier'].forEach(id=>{
    const sel=document.getElementById(id);
    sel.innerHTML=`<option value="">—</option>${opts}`;
  });
  // auto-guess
  const map={};
  head.forEach(h=>{ const g=guessHeader(h); if(g) map[g]=h; });
  if(map.code) document.getElementById('m_code').value=map.code;
  if(map.name) document.getElementById('m_name').value=map.name;
  if(map.unit) document.getElementById('m_unit').value=map.unit;
  if(map.price) document.getElementById('m_price').value=map.price;
  if(map.supplier) document.getElementById('m_supplier').value=map.supplier;
}

document.getElementById('file').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const data = await f.arrayBuffer();
  if(f.name.endsWith('.csv')){
    const text = new TextDecoder().decode(new Uint8Array(data));
    const lines=text.split(/\r?\n/).filter(Boolean).map(l=>l.split(','));
    WB=null; SHEETNAMES=['CSV']; DATA_BY_SHEET={'CSV':lines};
  }else{
    WB = XLSX.read(data, { type: 'array' });
    SHEETNAMES = WB.SheetNames;
    DATA_BY_SHEET = {};
    for(const sn of SHEETNAMES){
      const ws=WB.Sheets[sn];
      const aoa=XLSX.utils.sheet_to_json(ws,{header:1,blankrows:false});
      if(aoa && aoa.length) DATA_BY_SHEET[sn]=aoa;
    }
  }
  const sheetSel=document.getElementById('sheet');
  sheetSel.innerHTML=SHEETNAMES.map(n=>`<option>${n}</option>`).join('');
  renderPreview(SHEETNAMES[0]);
});

document.getElementById('sheet').addEventListener('change',(e)=>renderPreview(e.target.value));

document.getElementById('apply').addEventListener('click', async ()=>{
  const sn=document.getElementById('sheet').value;
  const rows=DATA_BY_SHEET[sn]||[];
  if(rows.length<2){ alert('Keine Daten erkannt.'); return; }

  const hCode=document.getElementById('m_code').value;
  const hName=document.getElementById('m_name').value;
  const hUnit=document.getElementById('m_unit').value;
  const hPrice=document.getElementById('m_price').value;
  const hSupp=document.getElementById('m_supplier').value;

  if(!hCode || !hName){ alert('Bitte mindestens Code und Name zuordnen.'); return; }

  const header=rows[0]; const idx=(name)=> header.indexOf(name);
  const iCode=idx(hCode), iName=idx(hName), iUnit=idx(hUnit), iPrice=idx(hPrice), iSupp=idx(hSupp);

  let ok=0, fail=0;
  for(let r=1;r<rows.length;r++){
    const row=rows[r];
    const payload={
      code: String(row[iCode]??'').trim(),
      name: String(row[iName]??'').trim(),
      unit: normalizeUnit(iUnit>=0?row[iUnit]:'g'),
      price_per_unit: parsePrice(iPrice>=0?row[iPrice]:0),
      supplier_code: iSupp>=0 ? String(row[iSupp]??'').trim()||null : null,
      note:''
    };
    if(!payload.code || !payload.name) { fail++; continue; }
    try{
      const resp=await fetch('/api/materials',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
      if(resp.ok) ok++; else fail++;
    }catch(e){ fail++; }
  }
  document.getElementById('msg').textContent=`Import abgeschlossen – OK: ${ok}, Fehler: ${fail}`;
});
(async()=>{ await guard(); })();
</script>
</body>
</html>
