<section class="space-y-8">
  <div class="flex items-center justify-between">
    <h1 class="text-2xl font-semibold">Production Plan</h1>
    <form method="get" action="/production" class="flex items-center gap-2">
      <label class="label">Datum</label>
      <input class="input" type="date" name="date" value="<%= date %>"/>
      <button class="btn-secondary">Anzeigen</button>
      <a class="btn-secondary" href="/admin">Admin</a>
    </form>
  </div>

  <!-- Add entry -->
  <div class="card">
    <h3 class="card-title">Eintrag hinzufügen</h3>
    <form action="/production/add" method="post" class="grid md:grid-cols-6 gap-3 text-sm">
      <input type="hidden" name="date" value="<%= date %>" />
      <div class="md:col-span-2">
        <label class="label">Artikel</label>
        <select class="input" name="item_id" required>
          <% items.forEach(it => { %>
            <option value="<%= it.id %>"><%= it.name %> (<%= it.code %>) – Yield: <%= it.yield_qty %> <%= it.yield_unit %></option>
          <% }) %>
        </select>
      </div>
      <div>
        <label class="label">Menge gesamt</label>
        <input class="input" name="total_qty" type="number" step="0.0001" required />
      </div>
      <div>
        <label class="label">Batch size</label>
        <input class="input" name="batch_size" type="number" step="0.0001" />
      </div>
      <div>
        <label class="label">Start</label>
        <input class="input" name="start_time" placeholder="04:30" />
      </div>
      <div>
        <label class="label">Station</label>
        <input class="input" name="station" placeholder="Backstube" />
      </div>
      <div class="md:col-span-6">
        <label class="label">Notizen</label>
        <input class="input" name="notes" />
      </div>
      <div class="md:col-span-6">
        <button class="btn-primary">Hinzufügen</button>
      </div>
    </form>
  </div>

  <!-- Plan list -->
  <div class="card">
    <h3 class="card-title">Plan für <%= date %></h3>
    <div class="overflow-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-2 pr-3">Start</th>
            <th class="py-2 pr-3">Artikel</th>
            <th class="py-2 pr-3">Menge</th>
            <th class="py-2 pr-3">Batch</th>
            <th class="py-2 pr-3">Station</th>
            <th class="py-2 pr-3">Notizen</th>
            <th class="py-2 pr-3"></th>
          </tr>
        </thead>
        <tbody>
          <% if (!plan.length) { %>
            <tr><td class="py-3 text-stone-500" colspan="7">Noch keine Einträge.</td></tr>
          <% } else { plan.forEach(p => { %>
            <tr class="border-b last:border-0">
              <td class="py-2 pr-3"><%= p.start_time || '' %></td>
              <td class="py-2 pr-3"><%= p.item_name %> <span class="text-xs text-stone-500">(<%= p.item_code %>)</span></td>
              <td class="py-2 pr-3"><%= p.total_qty %></td>
              <td class="py-2 pr-3"><%= p.batch_size || '' %></td>
              <td class="py-2 pr-3"><%= p.station || '' %></td>
              <td class="py-2 pr-3"><%= p.notes || '' %></td>
              <td class="py-2 pr-3">
                <form method="post" action="/production/<%= p.id %>/delete" onsubmit="return confirm('Löschen?');">
                  <input type="hidden" name="date" value="<%= date %>"/>
                  <button class="btn-secondary">Löschen</button>
                </form>
              </td>
            </tr>
          <% }) } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Usage -->
  <div class="card">
    <h3 class="card-title">Rohwarenbedarf (live)</h3>
    <div class="overflow-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-2 pr-3">Code</th>
            <th class="py-2 pr-3">Produkt</th>
            <th class="py-2 pr-3">Bedarf (Base)</th>
            <th class="py-2 pr-3">≈ Bedarf (Einkauf)</th>
            <th class="py-2 pr-3">Stückpreis/Unit</th>
            <th class="py-2 pr-3">Kosten</th>
          </tr>
        </thead>
        <tbody>
          <% if (!usage.length) { %>
            <tr><td class="py-3 text-stone-500" colspan="6">Keine Berechnung (kein Plan oder keine Rezepte/Zutaten).</td></tr>
          <% } else { usage.forEach(u => { %>
            <tr class="border-b last:border-0">
              <td class="py-2 pr-3 font-mono"><%= u.code %></td>
              <td class="py-2 pr-3"><%= u.name %></td>
              <td class="py-2 pr-3"><%= (u.need_base || 0).toFixed(2) %> <%= u.base_unit %></td>
              <td class="py-2 pr-3">
                <% if (u.need_purchase == null) { %>
                  <span class="text-stone-500">–</span>
                <% } else { %>
                  <%= u.need_purchase.toFixed(3) %> <%= u.purchase_unit %>
                <% } %>
              </td>
              <td class="py-2 pr-3"><%= Number(u.unit_cost || 0).toFixed(2) %> / <%= u.purchase_unit %></td>
              <td class="py-2 pr-3"><%= u.cost.toFixed(2) %> €</td>
            </tr>
          <% }) } %>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="py-2 pr-3 text-right font-medium">Gesamtkosten</td>
            <td class="py-2 pr-3 font-semibold"><%= totals.cost.toFixed(2) %> €</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</section>
