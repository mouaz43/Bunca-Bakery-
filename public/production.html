<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Production – BUNCA Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/styles.css">
</head>
<body class="wrap">
  <header class="nav">
    <div class="brand">BUNCA Planner</div>
    <nav>
      <a href="/">Dashboard</a>
      <a href="/production" class="active">Production</a>
      <a href="/admin">Admin</a>
      <button id="logout">Logout</button>
    </nav>
  </header>

  <section class="card">
    <h2>Produktionsplan</h2>
    <div class="grid">
      <div>
        <label>Datum</label>
        <input id="planDate" type="date" />
      </div>
      <div>
        <label>Artikel</label>
        <select id="itemSel"></select>
      </div>
      <div>
        <label>Menge (Ziel)</label>
        <input id="qty" type="number" min="0" step="1" />
      </div>
      <div class="row">
        <button id="add">Zeile hinzufügen</button>
        <button id="calc">Berechnen</button>
        <button id="save">Plan speichern</button>
      </div>
    </div>

    <table id="lines" class="mt">
      <thead><tr><th>Code</th><th>Name</th><th>Menge</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card">
    <h2>Rohwarenbedarf & Kosten</h2>
    <table id="req" class="mt">
      <thead><tr><th>Rohware</th><th>Code</th><th>Menge</th><th>€ / Base</th><th>Kosten (€)</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="4" style="text-align:right"><b>Gesamtkosten</b></td><td id="total">0.00</td></tr></tfoot>
    </table>
  </section>

<script>
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);
let items = [];
let lines = [];

async function loadItems(){
  const r = await fetch('/api/items'); const j = await r.json();
  items = j.data || [];
  const sel = $('#itemSel'); sel.innerHTML = '';
  for(const it of items){
    const o = document.createElement('option');
    o.value = it.code; o.textContent = `${it.name} (${it.yield_qty} ${it.yield_unit})`;
    sel.appendChild(o);
  }
}

function renderLines(){
  const tb = $('#lines tbody'); tb.innerHTML = '';
  for (let i=0;i<lines.length;i++){
    const L = lines[i];
    const tr = document.createElement('tr');
    const item = items.find(x=>x.code===L.item_code);
    tr.innerHTML =
      `<td>${L.item_code}</td><td>${item?item.name:''}</td>
       <td>${L.qty}</td>
       <td><button data-i="${i}" class="rm">Entfernen</button></td>`;
    tb.appendChild(tr);
  }
  tb.querySelectorAll('button.rm').forEach(b=>{
    b.onclick = ()=>{ lines.splice(Number(b.dataset.i),1); renderLines(); };
  });
}

$('#add').onclick = ()=>{
  const item_code = $('#itemSel').value;
  const qty = Number($('#qty').value || '0');
  if (!item_code || qty<=0) return;
  lines.push({ item_code, qty });
  renderLines();
};

$('#calc').onclick = async ()=>{
  const r = await fetch('/api/calc/requirements', {
    method:'POST', headers:{'content-type':'application/json'},
    body: JSON.stringify({ lines })
  });
  const j = await r.json();
  const tb = $('#req tbody'); tb.innerHTML = '';
  let total = 0;
  for (const row of j.data.rows){
    total += row.cost;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.product_name}</td><td>${row.product_code}</td><td>${row.qty_pretty}</td><td>${row.price_per_base.toFixed(4)}</td><td>${row.cost.toFixed(2)}</td>`;
    tb.appendChild(tr);
  }
  $('#total').textContent = total.toFixed(2);
};

$('#save').onclick = async ()=>{
  const plan_date = $('#planDate').value;
  if (!plan_date) { alert('Datum wählen'); return; }
  const r = await fetch('/api/production', {
    method:'POST', headers:{'content-type':'application/json'},
    body: JSON.stringify({ plan_date, lines })
  });
  if (r.ok) alert('Plan gespeichert'); else alert('Fehler beim Speichern');
};

document.getElementById('logout').onclick = async () => {
  await fetch('/api/logout',{method:'POST'}); location.href='/';
};

loadItems();
</script>
</body>
</html>
