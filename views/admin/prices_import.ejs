<section class="space-y-6 max-w-4xl">
  <h1 class="text-2xl font-semibold">Preise aus Excel einfügen</h1>

  <div class="card">
    <p class="text-sm text-stone-600 mb-3">
      Füge hier Zeilen aus Excel/Sheets ein. Formate:
    </p>
    <ul class="list-disc ml-6 text-sm space-y-1">
      <li><code>CODE, PREIS</code> — z.B. <code>WEIZENMEHL, 0.0007</code> (€/g direkt)</li>
      <li><code>CODE, PREIS, Einheit</code> — Einheit kann sein: <code>€/kg</code>, <code>€/l</code>, <code>€/g</code>, <code>€/ml</code>, <code>€/Stück</code></li>
      <li><code>Produktname, PREIS, Einheit</code> — Name wird zu Code gemappt (z.B. <em>Kristallzucker</em> → <code>ZUCKER</code>)</li>
    </ul>
    <p class="text-xs text-stone-500 mt-2">
      Umrechnung: €/kg → €/g, €/l → €/ml. Dezimaltrennzeichen und € werden automatisch erkannt (z.B. <code>18,49 €</code>). Formeln wie <code>55,47/3</code> sind erlaubt.
    </p>

    <form class="space-y-3 mt-4" method="post" action="/admin/prices-import">
      <textarea name="raw" rows="12" class="textarea font-mono" placeholder="Kristallzucker, 18,49 €, €/kg&#10;WEIZENMEHL, 0.0007"></textarea>
      <div class="flex gap-3">
        <button class="btn-primary" type="submit">Preise übernehmen</button>
        <a class="btn-secondary" href="/admin">Zurück</a>
      </div>
    </form>
  </div>

  <% if (locals.session && session.__price_import_debug) { 
       const dbg = session.__price_import_debug; %>
    <div class="card">
      <h3 class="card-title">Ergebnis</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h4 class="font-semibold mb-2 text-sm">Aktualisierte Preise (<%= dbg.updates.length %>)</h4>
          <pre class="bg-stone-50 p-3 rounded text-xs overflow-auto"><%= JSON.stringify(dbg.updates, null, 2) %></pre>
        </div>
        <div>
          <h4 class="font-semibold mb-2 text-sm">Fehler (<%= dbg.errors.length %>)</h4>
          <pre class="bg-stone-50 p-3 rounded text-xs overflow-auto"><%= JSON.stringify(dbg.errors, null, 2) %></pre>
        </div>
      </div>
    </div>
  <% } %>

  <div class="card">
    <h3 class="card-title">Bekannte Produkte (Code → Name → Basis-Einheit)</h3>
    <div class="overflow-auto">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-2 pr-3">Code</th>
            <th class="py-2 pr-3">Name</th>
            <th class="py-2 pr-3">Base</th>
            <th class="py-2 pr-3">Aktuell</th>
          </tr>
        </thead>
        <tbody>
          <% products.forEach(p => { %>
            <tr class="border-b last:border-0">
              <td class="py-2 pr-3 font-mono"><%= p.code %></td>
              <td class="py-2 pr-3"><%= p.name %></td>
              <td class="py-2 pr-3"><%= p.base_unit %></td>
              <td class="py-2 pr-3"><%= (p.unit_cost ?? 0).toLocaleString(undefined, {minimumFractionDigits: 6, maximumFractionDigits: 6}) %> €/ <%= p.base_unit %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</section>
