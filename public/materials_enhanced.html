<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bunca Bakery - Enhanced Materials Management</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
  <style>
    /* Enhanced Materials Styles */
    .materials-header {
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
    }
    
    @media (max-width: 768px) {
      .materials-header {
        grid-template-columns: 1fr;
        gap: 8px;
      }
    }
    
    .search-filters {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    @media (max-width: 768px) {
      .search-filters {
        grid-template-columns: 1fr;
      }
    }
    
    .table-enhanced {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .table-enhanced th {
      background: linear-gradient(135deg, var(--accent) 0%, #a07aff 100%);
      color: white;
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .table-enhanced td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
    }
    
    .table-enhanced tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }
    
    .stock-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stock-level {
      width: 60px;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .stock-fill {
      height: 100%;
      transition: width 0.3s ease;
    }
    
    .stock-fill.high { background: #6fe3a6; }
    .stock-fill.medium { background: #ffb24f; }
    .stock-fill.low { background: #ff6b6b; }
    .stock-fill.critical { background: #ff4757; }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-badge.active {
      background: rgba(111, 227, 166, 0.2);
      color: #6fe3a6;
    }
    
    .status-badge.reorder {
      background: rgba(255, 178, 79, 0.2);
      color: #ffb24f;
    }
    
    .status-badge.critical {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }
    
    .action-buttons {
      display: flex;
      gap: 4px;
    }
    
    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      background: var(--glass);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .btn-icon:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .btn-icon.edit { color: #7aa2ff; }
    .btn-icon.stock { color: #ffb24f; }
    .btn-icon.delete { color: #ff6b6b; }
    
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.open { display: flex; }
    
    .modal-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: min(600px, 100%);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-group label {
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }
    
    .form-group .help-text {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .input-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .input-addon {
      padding: 8px 12px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .bulk-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 12px 16px;
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 16px;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }
    
    .bulk-actions.visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    .checkbox-column {
      width: 40px;
      text-align: center;
    }
    
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
    }
    
    .loading-overlay.visible { display: flex; }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<header class="header">
  <nav class="nav">
    <div class="brand">üçû <strong>BUNCA</strong> Bakery - Rohwaren Management</div>
    <div class="menu-wrap">
      <button class="btn" onclick="location.href='/dashboard.html'">Dashboard</button>
      <button class="btn" onclick="location.href='/items.html'">Rezepte</button>
      <button class="btn" onclick="location.href='/plan.html'">Produktion</button>
      <button class="btn danger" onclick="logout()">Logout</button>
    </div>
  </nav>
</header>

<main class="container">
  <!-- Statistics Overview -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="totalMaterials">0</div>
      <div class="stat-label">Rohwaren Total</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="lowStockCount">0</div>
      <div class="stat-label">Niedrige Best√§nde</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="totalValue">‚Ç¨0</div>
      <div class="stat-label">Gesamtwert Lager</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" id="activeSuppliers">0</div>
      <div class="stat-label">Aktive Lieferanten</div>
    </div>
  </div>

  <!-- Main Materials Card -->
  <section class="card" style="position: relative;">
    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
    </div>
    
    <div class="card-title-row">
      <h2 style="margin:0">Rohwaren Verwaltung</h2>
      <div class="materials-header">
        <div></div>
        <button class="btn" onclick="importMaterials()">üì• Import</button>
        <button class="btn" onclick="exportMaterials()">üì§ Export</button>
        <button class="btn primary" onclick="openMaterialModal()">+ Neue Rohware</button>
      </div>
    </div>

    <!-- Search and Filters -->
    <div class="search-filters">
      <input id="searchInput" class="input" placeholder="Suchen nach Code, Name oder Lieferant..." />
      <select id="categoryFilter" class="input">
        <option value="">Alle Kategorien</option>
        <option value="flour">Mehl</option>
        <option value="dairy">Milchprodukte</option>
        <option value="sugar">Zucker & S√º√üstoffe</option>
        <option value="fat">Fette & √ñle</option>
        <option value="additive">Zusatzstoffe</option>
        <option value="other">Sonstiges</option>
      </select>
      <select id="statusFilter" class="input">
        <option value="">Alle Status</option>
        <option value="active">Aktiv</option>
        <option value="reorder">Nachbestellen</option>
        <option value="critical">Kritisch</option>
      </select>
      <button class="btn" onclick="applyFilters()">Filter</button>
    </div>

    <!-- Bulk Actions -->
    <div class="bulk-actions" id="bulkActions">
      <span id="selectedCount">0 ausgew√§hlt</span>
      <button class="btn" onclick="bulkUpdateStock()">Bestand aktualisieren</button>
      <button class="btn" onclick="bulkExport()">Exportieren</button>
      <button class="btn danger" onclick="bulkDelete()">L√∂schen</button>
    </div>

    <!-- Materials Table -->
    <div class="table-wrap" style="max-height: 600px; overflow-y: auto;">
      <table class="table-enhanced" id="materialsTable">
        <thead>
          <tr>
            <th class="checkbox-column">
              <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            </th>
            <th>Code</th>
            <th>Name</th>
            <th>Kategorie</th>
            <th>Bestand</th>
            <th>Status</th>
            <th>Preis/Einheit</th>
            <th>Lieferant</th>
            <th>Lagerort</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody id="materialsTableBody">
          <tr>
            <td colspan="10" class="text-center" style="padding: 40px;">
              Lade Rohwaren...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<!-- Material Modal -->
<div class="modal" id="materialModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Neue Rohware</h3>
      <button class="btn-icon" onclick="closeMaterialModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="materialForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="materialCode">Code *</label>
            <input type="text" id="materialCode" class="input" required>
            <div class="help-text">Eindeutiger Materialcode</div>
          </div>
          
          <div class="form-group">
            <label for="materialName">Name *</label>
            <input type="text" id="materialName" class="input" required>
          </div>
          
          <div class="form-group">
            <label for="materialCategory">Kategorie</label>
            <select id="materialCategory" class="input">
              <option value="">Kategorie w√§hlen</option>
              <option value="flour">Mehl</option>
              <option value="dairy">Milchprodukte</option>
              <option value="sugar">Zucker & S√º√üstoffe</option>
              <option value="fat">Fette & √ñle</option>
              <option value="additive">Zusatzstoffe</option>
              <option value="other">Sonstiges</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="baseUnit">Basiseinheit</label>
            <select id="baseUnit" class="input">
              <option value="g">Gramm (g)</option>
              <option value="ml">Milliliter (ml)</option>
              <option value="pcs">St√ºck (pcs)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="currentStock">Aktueller Bestand</label>
            <div class="input-group">
              <input type="number" id="currentStock" class="input" step="0.01" min="0">
              <span class="input-addon" id="stockUnit">g</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="minStock">Mindestbestand</label>
            <div class="input-group">
              <input type="number" id="minStock" class="input" step="0.01" min="0">
              <span class="input-addon" id="minStockUnit">g</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="reorderPoint">Bestellpunkt</label>
            <div class="input-group">
              <input type="number" id="reorderPoint" class="input" step="0.01" min="0">
              <span class="input-addon" id="reorderUnit">g</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="maxStock">Maximalbestand</label>
            <div class="input-group">
              <input type="number" id="maxStock" class="input" step="0.01" min="0">
              <span class="input-addon" id="maxStockUnit">g</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="pricePerUnit">Preis pro Einheit</label>
            <div class="input-group">
              <span class="input-addon">‚Ç¨</span>
              <input type="number" id="pricePerUnit" class="input" step="0.001" min="0">
            </div>
          </div>
          
          <div class="form-group">
            <label for="supplierCode">Lieferant</label>
            <input type="text" id="supplierCode" class="input">
          </div>
          
          <div class="form-group">
            <label for="storageLocation">Lagerort</label>
            <input type="text" id="storageLocation" class="input">
          </div>
          
          <div class="form-group">
            <label for="leadTimeDays">Lieferzeit (Tage)</label>
            <input type="number" id="leadTimeDays" class="input" min="1" value="7">
          </div>
          
          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="allergenInfo">Allergen-Informationen</label>
            <input type="text" id="allergenInfo" class="input" placeholder="z.B. Gluten, Milch, N√ºsse">
          </div>
          
          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="materialNote">Notizen</label>
            <textarea id="materialNote" class="input" rows="3"></textarea>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeMaterialModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveMaterial()">Speichern</button>
    </div>
  </div>
</div>

<!-- Stock Adjustment Modal -->
<div class="modal" id="stockModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Bestand anpassen</h3>
      <button class="btn-icon" onclick="closeStockModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Material</label>
        <div id="stockMaterialInfo" style="padding: 8px; background: var(--glass); border-radius: 6px;"></div>
      </div>
      <div class="form-group">
        <label for="newStockAmount">Neuer Bestand</label>
        <div class="input-group">
          <input type="number" id="newStockAmount" class="input" step="0.01" min="0">
          <span class="input-addon" id="stockAdjustUnit">g</span>
        </div>
      </div>
      <div class="form-group">
        <label for="adjustmentReason">Grund</label>
        <select id="adjustmentReason" class="input">
          <option value="manual_adjustment">Manuelle Korrektur</option>
          <option value="delivery">Lieferung</option>
          <option value="waste">Verderb/Verlust</option>
          <option value="inventory_count">Inventur</option>
          <option value="other">Sonstiges</option>
        </select>
      </div>
      <div class="form-group">
        <label for="adjustmentNotes">Notizen</label>
        <textarea id="adjustmentNotes" class="input" rows="2"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeStockModal()">Abbrechen</button>
      <button class="btn primary" onclick="saveStockAdjustment()">Bestand anpassen</button>
    </div>
  </div>
</div>

<script>
// Enhanced Materials Management JavaScript
let materialsData = [];
let selectedMaterials = new Set();
let currentEditingMaterial = null;

function logout() { 
  api('/api/logout', {method:'POST'}).then(() => location.href='/login.html'); 
}

// Initialize
(async function initMaterials() {
  try {
    const user = await sessionInfo();
    if (!user) {
      location.href = '/login.html';
      return;
    }
    
    await loadMaterials();
    setupEventListeners();
  } catch (e) {
    console.error('Materials initialization failed:', e);
    toast('Fehler beim Laden der Rohwaren');
  }
})();

function setupEventListeners() {
  // Search input
  $$('#searchInput').addEventListener('input', debounce(applyFilters, 300));
  
  // Unit change listeners
  $$('#baseUnit').addEventListener('change', updateUnitLabels);
  
  // Modal click outside to close
  $$('#materialModal').addEventListener('click', (e) => {
    if (e.target === $$('#materialModal')) closeMaterialModal();
  });
  
  $$('#stockModal').addEventListener('click', (e) => {
    if (e.target === $$('#stockModal')) closeStockModal();
  });
}

async function loadMaterials() {
  try {
    showLoading(true);
    const response = await api('/api/materials?active=true');
    materialsData = response.data || [];
    
    updateStatistics();
    renderMaterialsTable();
    showLoading(false);
  } catch (e) {
    console.error('Failed to load materials:', e);
    toast('Fehler beim Laden der Rohwaren');
    showLoading(false);
  }
}

function updateStatistics() {
  const totalMaterials = materialsData.length;
  const lowStockCount = materialsData.filter(m => m.needs_reorder || m.current_stock <= m.reorder_point).length;
  const totalValue = materialsData.reduce((sum, m) => sum + (m.current_stock * m.price_per_unit), 0);
  const activeSuppliers = new Set(materialsData.map(m => m.supplier_code).filter(Boolean)).size;
  
  $$('#totalMaterials').textContent = totalMaterials;
  $$('#lowStockCount').textContent = lowStockCount;
  $$('#totalValue').textContent = `‚Ç¨${totalValue.toFixed(0)}`;
  $$('#activeSuppliers').textContent = activeSuppliers;
}

function renderMaterialsTable() {
  const tbody = $$('#materialsTableBody');
  
  if (materialsData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" class="text-center" style="padding: 40px;">Keine Rohwaren gefunden</td></tr>';
    return;
  }
  
  tbody.innerHTML = materialsData.map(material => {
    const stockPercentage = material.max_stock > 0 ? 
      (material.current_stock / material.max_stock) * 100 : 
      material.current_stock > material.reorder_point ? 75 : 25;
    
    const stockClass = stockPercentage > 50 ? 'high' : 
                      stockPercentage > 25 ? 'medium' : 
                      stockPercentage > 10 ? 'low' : 'critical';
    
    const status = material.needs_reorder ? 'reorder' : 
                  material.current_stock <= material.min_stock ? 'critical' : 'active';
    
    const statusText = status === 'reorder' ? 'Nachbestellen' :
                      status === 'critical' ? 'Kritisch' : 'Aktiv';
    
    return `
      <tr>
        <td class="checkbox-column">
          <input type="checkbox" value="${material.code}" onchange="toggleMaterialSelection('${material.code}')">
        </td>
        <td><code>${material.code}</code></td>
        <td><strong>${material.name}</strong></td>
        <td>${getCategoryName(material.category || '')}</td>
        <td>
          <div class="stock-indicator">
            <span>${material.current_stock} ${material.base_unit}</span>
            <div class="stock-level">
              <div class="stock-fill ${stockClass}" style="width: ${Math.min(stockPercentage, 100)}%"></div>
            </div>
          </div>
        </td>
        <td><span class="status-badge ${status}">${statusText}</span></td>
        <td>‚Ç¨${material.price_per_unit.toFixed(3)}</td>
        <td>${material.supplier_name || material.supplier_code || '-'}</td>
        <td>${material.storage_location || '-'}</td>
        <td>
          <div class="action-buttons">
            <button class="btn-icon edit" onclick="editMaterial('${material.code}')" title="Bearbeiten">‚úèÔ∏è</button>
            <button class="btn-icon stock" onclick="adjustStock('${material.code}')" title="Bestand anpassen">üì¶</button>
            <button class="btn-icon delete" onclick="deleteMaterial('${material.code}')" title="L√∂schen">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function getCategoryName(category) {
  const categories = {
    'flour': 'Mehl',
    'dairy': 'Milchprodukte',
    'sugar': 'Zucker & S√º√üstoffe',
    'fat': 'Fette & √ñle',
    'additive': 'Zusatzstoffe',
    'other': 'Sonstiges'
  };
  return categories[category] || category || '-';
}

function applyFilters() {
  const search = $$('#searchInput').value.toLowerCase();
  const category = $$('#categoryFilter').value;
  const status = $$('#statusFilter').value;
  
  let filtered = materialsData;
  
  if (search) {
    filtered = filtered.filter(m => 
      m.code.toLowerCase().includes(search) ||
      m.name.toLowerCase().includes(search) ||
      (m.supplier_code && m.supplier_code.toLowerCase().includes(search))
    );
  }
  
  if (category) {
    filtered = filtered.filter(m => m.category === category);
  }
  
  if (status) {
    filtered = filtered.filter(m => {
      if (status === 'active') return !m.needs_reorder && m.current_stock > m.min_stock;
      if (status === 'reorder') return m.needs_reorder;
      if (status === 'critical') return m.current_stock <= m.min_stock;
      return true;
    });
  }
  
  // Temporarily replace materialsData for rendering
  const originalData = materialsData;
  materialsData = filtered;
  renderMaterialsTable();
  materialsData = originalData;
}

function toggleSelectAll() {
  const selectAll = $$('#selectAll');
  const checkboxes = $$$('tbody input[type="checkbox"]');
  
  checkboxes.forEach(cb => {
    cb.checked = selectAll.checked;
    if (selectAll.checked) {
      selectedMaterials.add(cb.value);
    } else {
      selectedMaterials.delete(cb.value);
    }
  });
  
  updateBulkActions();
}

function toggleMaterialSelection(code) {
  if (selectedMaterials.has(code)) {
    selectedMaterials.delete(code);
  } else {
    selectedMaterials.add(code);
  }
  updateBulkActions();
}

function updateBulkActions() {
  const bulkActions = $$('#bulkActions');
  const selectedCount = $$('#selectedCount');
  
  selectedCount.textContent = `${selectedMaterials.size} ausgew√§hlt`;
  
  if (selectedMaterials.size > 0) {
    bulkActions.classList.add('visible');
  } else {
    bulkActions.classList.remove('visible');
  }
}

function openMaterialModal(material = null) {
  currentEditingMaterial = material;
  const modal = $$('#materialModal');
  const title = $$('#modalTitle');
  
  if (material) {
    title.textContent = 'Rohware bearbeiten';
    fillMaterialForm(material);
  } else {
    title.textContent = 'Neue Rohware';
    clearMaterialForm();
  }
  
  modal.classList.add('open');
  updateUnitLabels();
}

function closeMaterialModal() {
  $$('#materialModal').classList.remove('open');
  currentEditingMaterial = null;
}

function fillMaterialForm(material) {
  $$('#materialCode').value = material.code;
  $$('#materialName').value = material.name;
  $$('#materialCategory').value = material.category || '';
  $$('#baseUnit').value = material.base_unit;
  $$('#currentStock').value = material.current_stock;
  $$('#minStock').value = material.min_stock;
  $$('#reorderPoint').value = material.reorder_point;
  $$('#maxStock').value = material.max_stock;
  $$('#pricePerUnit').value = material.price_per_unit;
  $$('#supplierCode').value = material.supplier_code || '';
  $$('#storageLocation').value = material.storage_location || '';
  $$('#leadTimeDays').value = material.lead_time_days || 7;
  $$('#allergenInfo').value = material.allergen_info || '';
  $$('#materialNote').value = material.note || '';
  
  // Disable code editing for existing materials
  $$('#materialCode').disabled = true;
}

function clearMaterialForm() {
  $$('#materialForm').reset();
  $$('#materialCode').disabled = false;
  $$('#leadTimeDays').value = 7;
}

function updateUnitLabels() {
  const unit = $$('#baseUnit').value;
  $$$('.input-addon').forEach(addon => {
    if (addon.id.includes('Unit')) {
      addon.textContent = unit;
    }
  });
}

async function saveMaterial() {
  try {
    const formData = {
      code: $$('#materialCode').value,
      name: $$('#materialName').value,
      category: $$('#materialCategory').value,
      base_unit: $$('#baseUnit').value,
      current_stock: Number($$('#currentStock').value) || 0,
      min_stock: Number($$('#minStock').value) || 0,
      reorder_point: Number($$('#reorderPoint').value) || 0,
      max_stock: Number($$('#maxStock').value) || 0,
      price_per_unit: Number($$('#pricePerUnit').value) || 0,
      supplier_code: $$('#supplierCode').value,
      storage_location: $$('#storageLocation').value,
      lead_time_days: Number($$('#leadTimeDays').value) || 7,
      allergen_info: $$('#allergenInfo').value,
      note: $$('#materialNote').value
    };
    
    if (!formData.code || !formData.name) {
      toast('Code und Name sind erforderlich');
      return;
    }
    
    await api('/api/materials', {
      method: 'POST',
      body: JSON.stringify(formData)
    });
    
    toast(currentEditingMaterial ? 'Rohware aktualisiert' : 'Rohware erstellt');
    closeMaterialModal();
    await loadMaterials();
  } catch (e) {
    console.error('Failed to save material:', e);
    toast('Fehler beim Speichern der Rohware');
  }
}

function editMaterial(code) {
  const material = materialsData.find(m => m.code === code);
  if (material) {
    openMaterialModal(material);
  }
}

function adjustStock(code) {
  const material = materialsData.find(m => m.code === code);
  if (!material) return;
  
  $$('#stockMaterialInfo').innerHTML = `
    <strong>${material.name}</strong> (${material.code})<br>
    <small>Aktueller Bestand: ${material.current_stock} ${material.base_unit}</small>
  `;
  
  $$('#newStockAmount').value = material.current_stock;
  $$('#stockAdjustUnit').textContent = material.base_unit;
  $$('#adjustmentReason').value = 'manual_adjustment';
  $$('#adjustmentNotes').value = '';
  
  $$('#stockModal').classList.add('open');
  $$('#stockModal').dataset.materialCode = code;
}

function closeStockModal() {
  $$('#stockModal').classList.remove('open');
}

async function saveStockAdjustment() {
  try {
    const code = $$('#stockModal').dataset.materialCode;
    const newAmount = Number($$('#newStockAmount').value);
    const reason = $$('#adjustmentReason').value;
    const notes = $$('#adjustmentNotes').value;
    
    await api(`/api/materials/${code}/adjust-stock`, {
      method: 'POST',
      body: JSON.stringify({
        quantity: newAmount,
        reason: reason,
        notes: notes
      })
    });
    
    toast('Bestand erfolgreich angepasst');
    closeStockModal();
    await loadMaterials();
  } catch (e) {
    console.error('Failed to adjust stock:', e);
    toast('Fehler beim Anpassen des Bestands');
  }
}

async function deleteMaterial(code) {
  if (!confirm('Sind Sie sicher, dass Sie diese Rohware l√∂schen m√∂chten?')) {
    return;
  }
  
  try {
    await api(`/api/materials/${code}`, { method: 'DELETE' });
    toast('Rohware gel√∂scht');
    await loadMaterials();
  } catch (e) {
    console.error('Failed to delete material:', e);
    toast('Fehler beim L√∂schen der Rohware');
  }
}

// Bulk operations
async function bulkUpdateStock() {
  if (selectedMaterials.size === 0) return;
  
  const newStock = prompt('Neuer Bestand f√ºr alle ausgew√§hlten Materialien:');
  if (!newStock) return;
  
  try {
    for (const code of selectedMaterials) {
      await api(`/api/materials/${code}/adjust-stock`, {
        method: 'POST',
        body: JSON.stringify({
          quantity: Number(newStock),
          reason: 'bulk_update',
          notes: 'Bulk-Update √ºber Dashboard'
        })
      });
    }
    
    toast(`Bestand f√ºr ${selectedMaterials.size} Materialien aktualisiert`);
    selectedMaterials.clear();
    updateBulkActions();
    await loadMaterials();
  } catch (e) {
    console.error('Bulk update failed:', e);
    toast('Fehler beim Bulk-Update');
  }
}

function bulkExport() {
  if (selectedMaterials.size === 0) return;
  
  const selectedData = materialsData.filter(m => selectedMaterials.has(m.code));
  const csv = convertToCSV(selectedData);
  downloadCSV(csv, 'selected_materials.csv');
}

async function bulkDelete() {
  if (selectedMaterials.size === 0) return;
  
  if (!confirm(`Sind Sie sicher, dass Sie ${selectedMaterials.size} Materialien l√∂schen m√∂chten?`)) {
    return;
  }
  
  try {
    for (const code of selectedMaterials) {
      await api(`/api/materials/${code}`, { method: 'DELETE' });
    }
    
    toast(`${selectedMaterials.size} Materialien gel√∂scht`);
    selectedMaterials.clear();
    updateBulkActions();
    await loadMaterials();
  } catch (e) {
    console.error('Bulk delete failed:', e);
    toast('Fehler beim Bulk-L√∂schen');
  }
}

// Import/Export functions
function importMaterials() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv,.xlsx';
  input.onchange = handleFileImport;
  input.click();
}

async function handleFileImport(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  try {
    // This would need a proper CSV/Excel parser
    toast('Import-Funktion wird implementiert...');
  } catch (e) {
    console.error('Import failed:', e);
    toast('Fehler beim Importieren');
  }
}

function exportMaterials() {
  const csv = convertToCSV(materialsData);
  downloadCSV(csv, 'materials_export.csv');
}

function convertToCSV(data) {
  const headers = ['Code', 'Name', 'Kategorie', 'Bestand', 'Einheit', 'Preis', 'Lieferant'];
  const rows = data.map(m => [
    m.code, m.name, m.category || '', m.current_stock, m.base_unit, 
    m.price_per_unit, m.supplier_code || ''
  ]);
  
  return [headers, ...rows].map(row => 
    row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
  ).join('\n');
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  window.URL.revokeObjectURL(url);
}

// Utility functions
function showLoading(show) {
  const overlay = $$('#loadingOverlay');
  if (show) {
    overlay.classList.add('visible');
  } else {
    overlay.classList.remove('visible');
  }
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}
</script>

</body>
</html>
