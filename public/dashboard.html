<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bunca Bakery — Dashboard</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
  <style>
    :root{
      --bg:#0b0e12;--card:#0f1115;--line:#23262d;--text:#e6e6e6;--muted:#9aa3af;
      --accent:#2563eb;--accent-rgb:37,99,235;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;
    }
    html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1100px;margin:0 auto;padding:18px}

    /* Header */
    .header{position:sticky;top:0;background:rgba(11,14,18,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--line);z-index:10}
    .nav{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 16px}
    .brand{font-weight:800;letter-spacing:.3px}
    .menu-wrap{display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid #2b2f36;background:#171a20;color:#f5f5f5;cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .btn.primary{background:var(--accent);border-color:var(--accent)}
    .btn.danger{background:#1f1517;border-color:#3a2327}

    /* Top controls */
    .auto-refresh-toggle{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);margin:16px 0}
    .toggle-switch{position:relative;width:40px;height:20px;background:var(--line);border-radius:10px;cursor:pointer;transition:.2s}
    .toggle-switch.active{background:var(--accent)}
    .toggle-switch::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;background:#fff;border-radius:50%;transition:.2s}
    .toggle-switch.active::after{transform:translateX(20px)}

    /* Metrics */
    .metrics-grid{display:grid;gap:16px;grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width:1000px){.metrics-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:560px){.metrics-grid{grid-template-columns:1fr}}
    .metric{background:linear-gradient(135deg,var(--card),rgba(255,255,255,.03));border:1px solid var(--line);border-radius:16px;padding:16px}
    .metric-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .metric-tag{font-size:11px;color:#dbe7ff;background:rgba(var(--accent-rgb),.12);border:1px solid rgba(var(--accent-rgb),.35);padding:2px 8px;border-radius:999px}
    .metric-val{font-size:28px;font-weight:800;line-height:1}
    .metric-sub{font-size:12px;color:var(--muted)}

    /* Grid */
    .grid{display:grid;gap:16px;grid-template-columns:2fr 1fr}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}

    /* Cards */
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .card-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .chip{font-size:12px;color:#dbe7ff;background:rgba(var(--accent-rgb),.12);border:1px solid rgba(var(--accent-rgb),.35);padding:2px 8px;border-radius:999px}

    /* Production list */
    .item{display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.02);margin-bottom:8px}
    .i-left{display:flex;gap:12px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.planned{background:#6b7280}.dot.progress{background:var(--warn)}.dot.done{background:var(--ok)}.dot.delay{background:var(--err)}
    .i-title{font-weight:600}
    .i-meta{font-size:12px;color:var(--muted)}

    /* Alerts */
    .alert{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;margin-bottom:8px;border-left:4px solid}
    .alert.info{background:rgba(37,99,235,.08);border-left-color:var(--accent)}
    .alert.warn{background:rgba(245,158,11,.10);border-left-color:var(--warn)}
    .alert.err{background:rgba(239,68,68,.10);border-left-color:var(--err)}
    .alert-title{font-weight:600}

    /* Mini chart */
    .mini{height:120px;background:rgba(255,255,255,.02);border:1px solid var(--line);border-radius:12px;padding:8px;display:flex;align-items:flex-end;gap:3px}
    .bar{flex:1;background:linear-gradient(to top,var(--accent),rgba(var(--accent-rgb),.35));border-radius:3px;min-height:4px;transition:.15s}
    .bar:hover{transform:scaleY(1.08)}

    /* Skeleton */
    .skeleton{height:20px;border-radius:8px;background:linear-gradient(90deg,rgba(255,255,255,.06) 25%,rgba(255,255,255,.12) 50%,rgba(255,255,255,.06) 75%);background-size:200% 100%;animation:load 1.3s infinite}
    @keyframes load{0%{background-position:200% 0}100%{background-position:-200% 0}}

    /* Refresh badge */
    .ref{position:fixed;top:20px;right:20px;background:rgba(16,185,129,.95);color:#06281f;padding:8px 14px;border-radius:18px;font-weight:700;opacity:0;transform:translateY(-8px);transition:.25s;z-index:50}
    .ref.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>

<header class="header">
  <nav class="nav">
    <div class="brand">BUNCA Bakery — Dashboard</div>
    <div class="menu-wrap">
      <button class="btn" onclick="location.href='/materials.html'">Rohwaren</button>
      <button class="btn" onclick="location.href='/items.html'">Rezepte</button>
      <button class="btn" onclick="location.href='/plan.html'">Planung</button>
      <button class="btn" onclick="location.href='/tools.html'">Tools</button>
      <button class="btn danger" onclick="logout()">Logout</button>
    </div>
  </nav>
</header>

<main class="container">
  <!-- Auto-refresh -->
  <div class="auto-refresh-toggle">
    <span>Auto-Refresh:</span>
    <div id="autoRefreshToggle" class="toggle-switch active" onclick="toggleAutoRefresh()"></div>
    <span id="refreshStatus">Aktiv (alle 30 s)</span>
  </div>

  <!-- Metrics -->
  <section class="metrics-grid" id="metrics">
    <div class="metric">
      <div class="metric-top"><div class="metric-tag">Effizienz</div><div id="effTrend" class="metric-sub"></div></div>
      <div id="effVal" class="metric-val">—</div>
      <div class="metric-sub">Produktion letzte 7 Tage</div>
    </div>

    <div class="metric">
      <div class="metric-top"><div class="metric-tag">Kosten</div><div id="costTrend" class="metric-sub"></div></div>
      <div id="costVal" class="metric-val">—</div>
      <div class="metric-sub">Diese Woche</div>
    </div>

    <div class="metric">
      <div class="metric-top"><div class="metric-tag">Lager</div><div id="invTrend" class="metric-sub"></div></div>
      <div id="invVal" class="metric-val">—</div>
      <div class="metric-sub">Verfügbarkeit</div>
    </div>

    <div class="metric">
      <div class="metric-top"><div class="metric-tag">Qualität</div><div id="qualTrend" class="metric-sub"></div></div>
      <div id="qualVal" class="metric-val">—</div>
      <div class="metric-sub">Letzte 30 Tage</div>
    </div>
  </section>

  <!-- Main grid -->
  <section class="grid">
    <div class="card">
      <div class="card-row">
        <h3 style="margin:0">Heutige Produktion</h3>
        <button class="btn" onclick="refreshProduction()">Aktualisieren</button>
      </div>
      <div id="productionList">
        <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
      </div>
    </div>

    <div class="card">
      <div class="card-row">
        <h3 style="margin:0">Benachrichtigungen</h3>
        <span id="alertCount" class="chip">0 aktiv</span>
      </div>
      <div id="alertsList">
        <div class="skeleton"></div><div class="skeleton"></div>
      </div>
    </div>
  </section>

  <!-- Cost trends -->
  <section class="card">
    <div class="card-row">
      <h3 style="margin:0">Kostentrends</h3>
      <div class="chip">Letzte 7 Tage</div>
    </div>
    <div id="costChart" class="mini"></div>
  </section>

  <!-- Inventory -->
  <section class="card">
    <div class="card-row">
      <h3 style="margin:0">Lagerüberblick</h3>
      <button class="btn" onclick="location.href='/materials.html'">Details</button>
    </div>
    <div id="inventoryOverview"><div class="skeleton"></div></div>
  </section>
</main>

<div id="refBadge" class="ref">Daten aktualisiert</div>

<script>
  // Uses app.js helpers: api, sessionInfo, toast
  let autoRefreshEnabled = true;
  let refreshInterval;
  const S = { analytics:{}, plan:[], materials:[], low:[] };

  function logout(){ api('/api/logout',{method:'POST'}).then(()=>location.href='/login.html'); }

  (async function init(){
    const user = await sessionInfo();
    if(!user){ location.href='/login.html'; return; }
    await loadAll();
    startAutoRefresh();
  })();

  async function loadAll(){
    try{
      showRef();
      // Analytics (counts/trends – your server exposes /api/analytics)
      const a = await api('/api/analytics').catch(()=>({}));
      S.analytics = a || {};

      // Materials (for low stock + inventory view)
      const m = await api('/api/materials').catch(()=>({data:[]}));
      S.materials = m.data || [];

      // Compute low stock client-side
      S.low = S.materials.filter(x => Number(x.current_stock||0) <= Number(x.min_stock||0));

      // Plan (today)
      const today = new Date().toISOString().slice(0,10);
      const p = await api('/api/plan?date='+today).catch(()=>([]));
      S.plan = Array.isArray(p) ? p : (p.data||[]);

      renderMetrics();
      renderProduction();
      renderAlerts();
      renderChart();
      renderInventory();
    }catch(err){
      console.error(err);
      toast('Fehler beim Laden der Dashboard-Daten','error');
    }
  }

  function renderMetrics(){
    // Efficiency proxy: completed vs planned (if analytics has counts)
    const prod = S.analytics.production || {};
    const completed = Number(prod.completed || 0);
    const planned   = Number(prod.total_planned || 0);
    const eff = planned>0 ? Math.round(100*completed/planned) : 0;
    setText('#effVal', eff+'%');
    setText('#effTrend', planned ? `${completed}/${planned} abgeschlossen` : 'Keine Daten');

    // Costs proxy: if analytics has counts, otherwise sum today
    if (S.analytics.materials_count !== undefined) {
      // If server doesn’t provide total cost, fallback to sum of plan line costs (already returned by /api/plan)
      const sum = S.plan.reduce((s,r)=>s+Number(r.total_cost||0),0);
      setText('#costVal', formatCurrency(sum));
      setText('#costTrend','Heute geplante Gesamtkosten');
    } else {
      setText('#costVal','—'); setText('#costTrend','Keine Daten');
    }

    // Inventory health
    const total = S.materials.length, low = S.low.length;
    const okPct = total ? Math.round(100*(total-low)/total) : 100;
    setText('#invVal', okPct+'%');
    setText('#invTrend', low>0 ? `${low} niedrig` : 'Optimal');

    // Quality placeholder (until you track quality)
    setText('#qualVal','100%');
    setText('#qualTrend','Keine Beanstandungen');
  }

  function renderProduction(){
    const box = qs('#productionList');
    const today = new Date().toISOString().slice(0,10);
    const todayRows = (S.plan||[]).filter(r => String(r.date||r.day).slice(0,10) === today);

    if(!todayRows.length){
      box.innerHTML = `
        <div style="text-align:center;padding:36px;color:var(--muted)">
          Keine Produktion für heute geplant
          <div style="margin-top:10px">
            <button class="btn primary" onclick="location.href='/plan.html'">Produktion planen</button>
          </div>
        </div>`;
      return;
    }

    box.innerHTML = todayRows.map(r=>{
      const status = (r.status||'planned').toLowerCase();
      const dot = status==='in_progress'?'progress':status==='completed'?'done':status==='delayed'?'delay':'planned';
      return `
        <div class="item">
          <div class="i-left">
            <div class="dot ${dot}"></div>
            <div>
              <div class="i-title">${escapeHtml(r.recipe_name || r.product_name || r.recipe_code || r.product_code)}</div>
              <div class="i-meta">${formatDate(r.date||r.day)}${r.shop?` • ${escapeHtml(r.shop)}`:''}</div>
            </div>
          </div>
          <div class="i-title">${formatNumber(r.quantity||r.qty||0,0)} ${r.yield_unit||'Stück'}</div>
        </div>`;
    }).join('');
  }

  function renderAlerts(){
    const list = qs('#alertsList');
    const alerts = [];

    // Low stock alerts
    S.low.forEach(m => alerts.push({
      type:'warn',
      title:'Niedriger Lagerbestand',
      msg:`${m.name}: ${formatNumber(m.current_stock,2)} ${m.base_unit} (Min: ${formatNumber(m.min_stock,2)})`
    }));

    // Delayed/in-progress production alerts
    const delaying = (S.plan||[]).filter(p => (p.status||'').toLowerCase()==='delayed').length;
    if (delaying) alerts.push({type:'err', title:'Verzögerte Aufträge', msg:`${delaying} Einträge sind verzögert`});
    const running = (S.plan||[]).filter(p => (p.status||'').toLowerCase()==='in_progress').length;
    if (running) alerts.push({type:'info', title:'Produktion läuft', msg:`${running} Einträge in Bearbeitung`});

    qs('#alertCount').textContent = `${alerts.length} aktiv`;

    list.innerHTML = alerts.length ? alerts.map(a=>`
      <div class="alert ${a.type}">
        <div>
          <div class="alert-title">${a.title}</div>
          <div class="i-meta">${a.msg}</div>
        </div>
      </div>`).join('') :
      `<div style="text-align:center;padding:36px;color:var(--muted)">Keine aktiven Benachrichtigungen</div>`;
  }

  function renderChart(){
    const el = qs('#costChart');
    // Build a 7-day window from plan totals
    const map = new Map();
    (S.plan||[]).forEach(r=>{
      const d = String(r.date||r.day).slice(0,10);
      const v = Number(r.total_cost||0);
      map.set(d, (map.get(d)||0) + v);
    });
    // Ensure 7 days present
    const days = [];
    for(let i=6;i>=0;i--){
      const d = new Date(Date.now()-i*86400000).toISOString().slice(0,10);
      days.push({date:d, total: map.get(d)||0});
    }
    const max = Math.max(1, ...days.map(x=>x.total));
    el.innerHTML = days.map(x=>{
      const h = Math.max(4, Math.round(100 * x.total / max));
      return `<div class="bar" style="height:${h}%"
                 title="${x.date}: ${formatCurrency(x.total)}"></div>`;
    }).join('');
  }

  function renderInventory(){
    const el = qs('#inventoryOverview');
    const top = S.materials.slice(0,10);
    if(!top.length){
      el.innerHTML = `<div style="text-align:center;padding:24px;color:var(--muted)">Keine Materialien gefunden</div>`;
      return;
    }
    el.innerHTML = top.map(m=>{
      const pct = Number(m.min_stock)>0 ? (100*Number(m.current_stock||0)/Number(m.min_stock)).toFixed(0) : 200;
      const color = pct<=100 ? 'var(--err)' : pct<=150 ? 'var(--warn)' : 'var(--ok)';
      return `
        <div class="item">
          <div class="i-left">
            <div class="dot" style="background:${color}"></div>
            <div>
              <div class="i-title">${escapeHtml(m.name)}</div>
              <div class="i-meta">${escapeHtml(m.code)} • ${escapeHtml(m.base_unit)}</div>
            </div>
          </div>
          <div class="i-title">${formatNumber(m.current_stock,2)} ${escapeHtml(m.base_unit)}</div>
        </div>`;
    }).join('');
  }

  function startAutoRefresh(){
    if(refreshInterval) clearInterval(refreshInterval);
    if(autoRefreshEnabled){
      refreshInterval = setInterval(loadAll, 30000);
    }
  }

  function toggleAutoRefresh(){
    autoRefreshEnabled = !autoRefreshEnabled;
    const t = qs('#autoRefreshToggle'); const s = qs('#refreshStatus');
    if(autoRefreshEnabled){ t.classList.add('active'); s.textContent='Aktiv (alle 30 s)'; startAutoRefresh(); }
    else { t.classList.remove('active'); s.textContent='Deaktiviert'; if(refreshInterval) clearInterval(refreshInterval); }
  }

  function refreshProduction(){ loadAll().then(()=>toast('Produktionsdaten aktualisiert','info')); }

  function showRef(){ const b=qs('#refBadge'); b.classList.add('show'); setTimeout(()=>b.classList.remove('show'),1600); }

  /* -------- utilities -------- */
  function qs(s){ return document.querySelector(s); }
  function setText(sel, txt){ const el=qs(sel); if(el) el.textContent = txt; }
  function formatCurrency(n, c='EUR'){ return new Intl.NumberFormat('de-DE',{style:'currency',currency:c}).format(Number(n||0)); }
  function formatDate(d){ return new Intl.DateTimeFormat('de-DE',{year:'numeric',month:'short',day:'numeric'}).format(new Date(d)); }
  function formatNumber(n,d=2){ return new Intl.NumberFormat('de-DE',{minimumFractionDigits:d,maximumFractionDigits:d}).format(Number(n||0)); }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
</script>

</body>
</html>
