<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bakeflow — Tools</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
</head>
<body data-active="tools">
<div id="appHeader"></div>

<div class="container">
  <div class="grid">
    <div class="card">
      <h3>Export</h3>
      <p class="muted"><small>CSV, JSON oder Excel (XLSX).</small></p>
      <div class="row">
        <select id="ds" class="input w150">
          <option>materials</option><option>items</option><option>bom</option><option>plan</option>
        </select>
        <select id="fmt" class="input w120">
          <option>json</option><option>csv</option><option>xlsx</option>
        </select>
        <input id="week" class="input w150" type="date" placeholder="Woche (nur für plan)">
        <button id="exportBtn" class="btn primary">Download</button>
      </div>
    </div>

    <div class="card">
      <h3>Backup & Restore</h3>
      <div class="row">
        <button id="backupBtn" class="btn">Backup herunterladen</button>
        <input id="restoreFile" class="input" type="file" accept=".json">
        <button id="restoreBtn" class="btn primary adminOnly">Backup einspielen</button>
      </div>
      <p class="muted"><small>Restore ersetzt Materialien, Items, BOM, Plan. Nur Admin.</small></p>
    </div>

    <div class="card adminOnly">
      <h3>Nutzer verwalten (Admin)</h3>
      <div class="row">
        <input id="uEmail" class="input w150" placeholder="email@example.com">
        <input id="uPass"  class="input w150" type="password" placeholder="Passwort">
        <select id="uRole" class="input w120"><option>viewer</option><option>planner</option><option>admin</option></select>
        <button id="uSave" class="btn primary">Speichern</button>
      </div>
      <div id="uList" class="muted" style="margin-top:8px">lädt…</div>
    </div>
  </div>
</div>

<script>
let ROLE = 'viewer';
(async () => {
  const u = await sessionInfo();
  if (u) ROLE = u.role || 'viewer';
  if (ROLE !== 'admin') document.querySelectorAll('.adminOnly').forEach(el => el.style.display='none');
})();

document.getElementById('exportBtn').onclick = () => {
  const ds = $$('#ds').value, fmt = $$('#fmt').value, wk = $$('#week').value;
  window.location = `/api/tools/export/${encodeURIComponent(ds)}?format=${encodeURIComponent(fmt)}${wk?`&start=${encodeURIComponent(wk)}`:''}`;
};
document.getElementById('backupBtn').onclick = () => { window.location = '/api/tools/backup'; };
document.getElementById('restoreBtn').onclick = async () => {
  if (ROLE !== 'admin') return toast('Nur Admin darf Restore ausführen');
  const file = $$('#restoreFile').files?.[0]; if (!file) return toast('Bitte Backup-Datei wählen');
  try { const obj = JSON.parse(await file.text());
    await api('/api/tools/backup/restore', { method:'POST', body: JSON.stringify(obj) }); toast('Backup eingespielt');
  } catch(e){ toast('Restore fehlgeschlagen: '+e.message); }
};

async function loadUsers(){
  if (ROLE !== 'admin') { $$('#uList').textContent = 'Keine Admin-Rechte.'; return; }
  try {
    const { data } = await api('/api/users');
    $$('#uList').innerHTML = data.length
      ? data.map(u => `<div class="row"><div style="min-width:220px">${u.email}</div><div>${u.role}</div>
        <button data-email="${u.email}" class="btn">Löschen</button></div>`).join('')
      : '<div>Keine Nutzer</div>';
    document.querySelectorAll('#uList [data-email]').forEach(b => b.onclick = async () => {
      if (!confirm('Nutzer wirklich löschen?')) return;
      try { await api('/api/users/' + encodeURIComponent(b.dataset.email), { method:'DELETE' }); loadUsers(); toast('Gelöscht'); } catch(e){ toast('Fehler: '+e.message); }
    });
  } catch(e){ $$('#uList').textContent = 'Fehler: '+e.message; }
}
document.getElementById('uSave').onclick = async () => {
  if (ROLE !== 'admin') return toast('Nur Admin darf Nutzer speichern');
  try {
    await api('/api/users', { method:'POST', body: JSON.stringify({
      email: $$('#uEmail').value.trim(), password: $$('#uPass').value, role: $$('#uRole').value
    })}); toast('Nutzer gespeichert'); loadUsers();
  } catch(e){ toast('Fehler: '+e.message); }
};
loadUsers();
</script>
</body>
</html>
