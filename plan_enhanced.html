<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bunca Bakery - Enhanced Production Planning</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
  <style>
    /* Enhanced Production Planning Styles */
    .planning-header {
      display: grid;
      grid-template-columns: auto 1fr auto auto auto;
      gap: 12px;
      align-items: center;
      padding: 16px 20px;
      background: linear-gradient(135deg, var(--card) 0%, rgba(255,255,255,0.02) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .week-navigation {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .week-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      min-width: 200px;
    }
    
    .nav-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--glass);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .nav-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .quick-add {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      max-width: 600px;
    }
    
    .quick-add input {
      flex: 1;
      min-width: 300px;
    }
    
    .auto-save-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: rgba(111, 227, 166, 0.1);
      border: 1px solid rgba(111, 227, 166, 0.3);
      border-radius: 8px;
      font-size: 12px;
      color: #6fe3a6;
    }
    
    .save-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #6fe3a6;
      animation: pulse 2s infinite;
    }
    
    .production-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background: var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .day-column {
      background: var(--card);
      min-height: 400px;
      display: flex;
      flex-direction: column;
    }
    
    .day-header {
      padding: 16px 12px;
      background: linear-gradient(135deg, var(--accent) 0%, #a07aff 100%);
      color: white;
      text-align: center;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .day-date {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 2px;
    }
    
    .day-content {
      flex: 1;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .production-item {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }
    
    .production-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      border-color: var(--accent);
    }
    
    .production-item.in-progress {
      border-left: 4px solid #ffb24f;
      background: rgba(255, 178, 79, 0.05);
    }
    
    .production-item.completed {
      border-left: 4px solid #6fe3a6;
      background: rgba(111, 227, 166, 0.05);
    }
    
    .production-item.delayed {
      border-left: 4px solid #ff6b6b;
      background: rgba(255, 107, 107, 0.05);
    }
    
    .item-header {
      display: flex;
      justify-content: between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .item-code {
      font-weight: 700;
      color: var(--accent);
      font-size: 14px;
    }
    
    .item-name {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    .item-time {
      font-family: monospace;
      font-size: 11px;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.05);
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .item-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
    }
    
    .item-quantity {
      font-weight: 600;
      color: var(--text);
    }
    
    .item-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    .status-planned {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }
    
    .status-in-progress {
      background: rgba(255, 178, 79, 0.2);
      color: #ffb24f;
    }
    
    .status-completed {
      background: rgba(111, 227, 166, 0.2);
      color: #6fe3a6;
    }
    
    .add-production {
      border: 2px dashed var(--border);
      background: transparent;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
    }
    
    .add-production:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(var(--accent-rgb), 0.05);
    }
    
    .optimization-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .optimization-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .optimization-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    
    .metric-box {
      text-align: center;
      padding: 16px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 4px;
    }
    
    .metric-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .cost-analysis {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      position: sticky;
      bottom: 0;
      z-index: 20;
      backdrop-filter: blur(10px);
    }
    
    .cost-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .cost-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .cost-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 6px;
    }
    
    .cost-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.open { display: flex; }
    
    .modal-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: min(800px, 100%);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-group label {
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }
    
    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    
    .suggestions-dropdown.open { display: block; }
    
    .suggestion-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    
    .suggestion-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .drag-placeholder {
      border: 2px dashed var(--accent);
      background: rgba(var(--accent-rgb), 0.1);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: var(--accent);
      margin: 8px 0;
    }
    
    .equipment-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }
    
    .equipment-icon {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      background: var(--accent);
    }
    
    .equipment-icon.busy {
      background: #ff6b6b;
    }
    
    .equipment-icon.available {
      background: #6fe3a6;
    }
    
    @media (max-width: 1200px) {
      .production-grid {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .day-column {
        min-height: auto;
      }
      
      .day-header {
        position: static;
      }
    }
  </style>
</head>
<body>

<header class="header">
  <nav class="nav">
    <div class="brand">🍞 <strong>BUNCA</strong> Bakery - Produktionsplanung</div>
    <div class="menu-wrap">
      <button class="btn" onclick="location.href='/dashboard.html'">Dashboard</button>
      <button class="btn" onclick="location.href='/materials.html'">Rohwaren</button>
      <button class="btn" onclick="location.href='/items.html'">Rezepte</button>
      <button class="btn" onclick="location.href='/analytics.html'">Analytics</button>
      <button class="btn danger" onclick="logout()">Logout</button>
    </div>
  </nav>
</header>

<main class="container">
  <!-- Planning Header -->
  <div class="planning-header">
    <div class="week-navigation">
      <button class="nav-btn" onclick="changeWeek(-1)">←</button>
      <div class="week-title" id="weekTitle">Woche</div>
      <button class="nav-btn" onclick="changeWeek(1)">→</button>
    </div>
    
    <div class="quick-add">
      <input 
        id="quickAddInput" 
        class="input" 
        placeholder='Schnelleingabe: "MO 08:00-10:00 BROT_WEISS 50 @Filiale1" oder "heute 6:00 CROISSANT 30"'
        onkeypress="handleQuickAdd(event)"
      />
      <button class="btn primary" onclick="processQuickAdd()">Hinzufügen</button>
    </div>
    
    <div class="auto-save-indicator" id="autoSaveStatus">
      <div class="save-dot"></div>
      <span>Auto-Speichern aktiv</span>
    </div>
  </div>

  <!-- Optimization Panel -->
  <div class="optimization-panel">
    <div class="optimization-header">
      <h3>🚀 Produktionsoptimierung</h3>
      <div style="display: flex; gap: 8px;">
        <button class="btn" onclick="optimizeProduction()">Optimieren</button>
        <button class="btn" onclick="validateProduction()">Validieren</button>
        <button class="btn" onclick="generateRecommendations()">Empfehlungen</button>
      </div>
    </div>
    
    <div class="optimization-metrics">
      <div class="metric-box">
        <div class="metric-value" id="efficiencyScore">94%</div>
        <div class="metric-label">Effizienz</div>
      </div>
      <div class="metric-box">
        <div class="metric-value" id="capacityUtilization">78%</div>
        <div class="metric-label">Kapazitätsauslastung</div>
      </div>
      <div class="metric-box">
        <div class="metric-value" id="equipmentConflicts">2</div>
        <div class="metric-label">Konflikte</div>
      </div>
      <div class="metric-box">
        <div class="metric-value" id="totalBatches">24</div>
        <div class="metric-label">Geplante Chargen</div>
      </div>
    </div>
  </div>

  <!-- Production Grid -->
  <div class="production-grid" id="productionGrid">
    <!-- Days will be populated by JavaScript -->
  </div>

  <!-- Cost Analysis Panel -->
  <div class="cost-analysis">
    <div class="cost-header">
      <h3>💰 Kostenanalyse</h3>
      <div style="display: flex; gap: 8px;">
        <button class="btn" onclick="calculateCosts()">Berechnen</button>
        <button class="btn" onclick="exportCostReport()">Export</button>
        <button class="btn" onclick="showDetailedCosts()">Details</button>
      </div>
    </div>
    
    <div class="cost-breakdown">
      <div class="cost-item">
        <span>Materialkosten:</span>
        <strong id="materialCosts">€0.00</strong>
      </div>
      <div class="cost-item">
        <span>Arbeitskosten:</span>
        <strong id="laborCosts">€0.00</strong>
      </div>
      <div class="cost-item">
        <span>Gemeinkosten:</span>
        <strong id="overheadCosts">€0.00</strong>
      </div>
      <div class="cost-item">
        <span>Gesamtkosten:</span>
        <strong id="totalCosts">€0.00</strong>
      </div>
    </div>
    
    <div id="costWarnings" style="margin-top: 12px; display: none;">
      <!-- Cost warnings will be populated here -->
    </div>
  </div>
</main>

<!-- Production Item Modal -->
<div class="modal" id="productionModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Produktion bearbeiten</h3>
      <button class="btn-icon" onclick="closeProductionModal()">✕</button>
    </div>
    <div class="modal-body">
      <form id="productionForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="productCode">Produkt *</label>
            <div style="position: relative;">
              <input type="text" id="productCode" class="input" required>
              <div class="suggestions-dropdown" id="productSuggestions">
                <!-- Product suggestions will be populated here -->
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="quantity">Menge *</label>
            <input type="number" id="quantity" class="input" step="0.01" min="0" required>
          </div>
          
          <div class="form-group">
            <label for="startTime">Startzeit</label>
            <input type="time" id="startTime" class="input">
          </div>
          
          <div class="form-group">
            <label for="endTime">Endzeit</label>
            <input type="time" id="endTime" class="input">
          </div>
          
          <div class="form-group">
            <label for="shop">Filiale/Standort</label>
            <input type="text" id="shop" class="input">
          </div>
          
          <div class="form-group">
            <label for="priority">Priorität</label>
            <select id="priority" class="input">
              <option value="1">Sehr niedrig</option>
              <option value="3">Niedrig</option>
              <option value="5" selected>Normal</option>
              <option value="7">Hoch</option>
              <option value="9">Sehr hoch</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="assignedStaff">Zugewiesenes Personal</label>
            <input type="text" id="assignedStaff" class="input" placeholder="Komma-getrennt">
          </div>
          
          <div class="form-group">
            <label for="equipmentRequired">Benötigte Ausrüstung</label>
            <input type="text" id="equipmentRequired" class="input" placeholder="Komma-getrennt">
          </div>
          
          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="productionNotes">Notizen</label>
            <textarea id="productionNotes" class="input" rows="3"></textarea>
          </div>
        </div>
        
        <!-- Recipe Preview -->
        <div id="recipePreview" style="margin-top: 20px; display: none;">
          <h4>Rezept-Vorschau</h4>
          <div id="recipeDetails">
            <!-- Recipe details will be populated here -->
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeProductionModal()">Abbrechen</button>
      <button class="btn" onclick="duplicateProduction()" id="duplicateBtn" style="display: none;">Duplizieren</button>
      <button class="btn danger" onclick="deleteProduction()" id="deleteBtn" style="display: none;">Löschen</button>
      <button class="btn primary" onclick="saveProduction()">Speichern</button>
    </div>
  </div>
</div>

<!-- Optimization Results Modal -->
<div class="modal" id="optimizationModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>🚀 Optimierungsergebnisse</h3>
      <button class="btn-icon" onclick="closeOptimizationModal()">✕</button>
    </div>
    <div class="modal-body">
      <div id="optimizationResults">
        <!-- Optimization results will be populated here -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeOptimizationModal()">Schließen</button>
      <button class="btn primary" onclick="applyOptimization()">Optimierung anwenden</button>
    </div>
  </div>
</div>

<script>
// Enhanced Production Planning JavaScript
let currentWeekStart = getStartOfWeek(new Date());
let productionData = [];
let itemsData = [];
let currentEditingProduction = null;
let autoSaveTimeout = null;

function logout() { 
  api('/api/logout', {method:'POST'}).then(() => location.href='/login.html'); 
}

// Initialize
(async function initProductionPlanning() {
  try {
    const user = await sessionInfo();
    if (!user) {
      location.href = '/login.html';
      return;
    }
    
    await loadItemsData();
    await loadProductionWeek();
    setupEventListeners();
    setupDragAndDrop();
    startAutoSave();
  } catch (e) {
    console.error('Production planning initialization failed:', e);
    toast('Fehler beim Laden der Produktionsplanung');
  }
})();

function setupEventListeners() {
  // Product code input with suggestions
  $$('#productCode').addEventListener('input', debounce(showProductSuggestions, 300));
  $$('#productCode').addEventListener('blur', () => {
    setTimeout(() => $$('#productSuggestions').classList.remove('open'), 200);
  });
  
  // Quantity change to update recipe preview
  $$('#quantity').addEventListener('input', debounce(updateRecipePreview, 500));
  
  // Quick add input
  $$('#quickAddInput').addEventListener('keypress', handleQuickAdd);
  
  // Modal click outside to close
  $$('#productionModal').addEventListener('click', (e) => {
    if (e.target === $$('#productionModal')) closeProductionModal();
  });
  
  $$('#optimizationModal').addEventListener('click', (e) => {
    if (e.target === $$('#optimizationModal')) closeOptimizationModal();
  });
}

function setupDragAndDrop() {
  // Enable drag and drop for production items
  document.addEventListener('dragstart', (e) => {
    if (e.target.classList.contains('production-item')) {
      e.dataTransfer.setData('text/plain', e.target.dataset.productionId);
      e.target.style.opacity = '0.5';
    }
  });
  
  document.addEventListener('dragend', (e) => {
    if (e.target.classList.contains('production-item')) {
      e.target.style.opacity = '1';
    }
  });
  
  document.addEventListener('dragover', (e) => {
    e.preventDefault();
  });
  
  document.addEventListener('drop', async (e) => {
    e.preventDefault();
    const productionId = e.dataTransfer.getData('text/plain');
    const dayColumn = e.target.closest('.day-column');
    
    if (dayColumn && productionId) {
      const newDate = dayColumn.dataset.date;
      await moveProduction(productionId, newDate);
    }
  });
}

function startAutoSave() {
  // Auto-save changes every 30 seconds
  setInterval(async () => {
    try {
      await saveAllChanges();
      updateAutoSaveStatus('Automatisch gespeichert');
    } catch (e) {
      updateAutoSaveStatus('Fehler beim Speichern', true);
    }
  }, 30000);
}

async function loadItemsData() {
  try {
    const response = await api('/api/items?active=true');
    itemsData = response.data || [];
  } catch (e) {
    console.error('Failed to load items:', e);
  }
}

async function loadProductionWeek() {
  try {
    const weekStart = formatDate(currentWeekStart);
    const response = await api(`/api/plan?week_start=${weekStart}`);
    productionData = response.data || [];
    
    renderProductionGrid();
    updateWeekTitle();
    await calculateAndDisplayCosts();
    updateOptimizationMetrics();
  } catch (e) {
    console.error('Failed to load production week:', e);
    toast('Fehler beim Laden der Produktionswoche');
  }
}

function renderProductionGrid() {
  const grid = $$('#productionGrid');
  const days = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
  
  grid.innerHTML = days.map((dayName, index) => {
    const date = new Date(currentWeekStart);
    date.setDate(date.getDate() + index);
    const dateStr = formatDate(date);
    const dayProductions = productionData.filter(p => p.day === dateStr);
    
    return `
      <div class="day-column" data-date="${dateStr}">
        <div class="day-header">
          <div>${dayName}</div>
          <div class="day-date">${formatDisplayDate(date)}</div>
        </div>
        <div class="day-content">
          ${dayProductions.map(production => renderProductionItem(production)).join('')}
          <div class="add-production" onclick="addProduction('${dateStr}')">
            + Produktion hinzufügen
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function renderProductionItem(production) {
  const statusClass = production.status || 'planned';
  const timeDisplay = production.start_time ? 
    `${production.start_time}${production.end_time ? '-' + production.end_time : ''}` : 
    'Zeit TBD';
  
  return `
    <div class="production-item ${statusClass}" 
         data-production-id="${production.id}"
         draggable="true"
         onclick="editProduction(${production.id})">
      <div class="item-header">
        <div>
          <div class="item-code">${production.product_code}</div>
          <div class="item-name">${production.product_name || ''}</div>
        </div>
        <div class="item-time">${timeDisplay}</div>
      </div>
      <div class="item-details">
        <div class="item-quantity">${production.qty} Stück</div>
        <div class="item-status status-${statusClass}">
          ${getStatusText(production.status)}
        </div>
      </div>
      ${production.shop ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">📍 ${production.shop}</div>` : ''}
      ${renderEquipmentIndicators(production.equipment_required)}
    </div>
  `;
}

function renderEquipmentIndicators(equipment) {
  if (!equipment || !Array.isArray(equipment) || equipment.length === 0) {
    return '';
  }
  
  return `
    <div class="equipment-indicator">
      ${equipment.map(eq => `
        <div class="equipment-icon available" title="${eq}"></div>
      `).join('')}
    </div>
  `;
}

function getStatusText(status) {
  const statusMap = {
    'planned': 'Geplant',
    'in_progress': 'In Arbeit',
    'completed': 'Abgeschlossen',
    'cancelled': 'Abgebrochen',
    'delayed': 'Verspätet'
  };
  return statusMap[status] || 'Geplant';
}

function updateWeekTitle() {
  const endDate = new Date(currentWeekStart);
  endDate.setDate(endDate.getDate() + 6);
  
  $$('#weekTitle').textContent = 
    `${formatDisplayDate(currentWeekStart)} - ${formatDisplayDate(endDate)}`;
}

function changeWeek(direction) {
  currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
  loadProductionWeek();
}

function handleQuickAdd(event) {
  if (event.key === 'Enter') {
    processQuickAdd();
  }
}

async function processQuickAdd() {
  const input = $$('#quickAddInput');
  const text = input.value.trim();
  
  if (!text) return;
  
  try {
    const parsed = parseQuickAddText(text);
    if (parsed) {
      await saveProductionItem(parsed);
      input.value = '';
      await loadProductionWeek();
      toast('Produktion hinzugefügt');
    } else {
      toast('Ungültiges Format. Beispiel: "MO 08:00-10:00 BROT_WEISS 50 @Filiale1"');
    }
  } catch (e) {
    console.error('Quick add failed:', e);
    toast('Fehler beim Hinzufügen der Produktion');
  }
}

function parseQuickAddText(text) {
  // Parse formats like:
  // "MO 08:00-10:00 BROT_WEISS 50 @Filiale1"
  // "heute 6:00 CROISSANT 30"
  // "morgen 14:00-16:00 KUCHEN_SCHOKO 20"
  
  const patterns = [
    /^(MO|DI|MI|DO|FR|SA|SO|heute|morgen)\s+(\d{1,2}:\d{2})(?:-(\d{1,2}:\d{2}))?\s+(\w+)\s+(\d+(?:\.\d+)?)\s*(?:@(\w+))?$/i,
    /^(\d{4}-\d{2}-\d{2})\s+(\d{1,2}:\d{2})(?:-(\d{1,2}:\d{2}))?\s+(\w+)\s+(\d+(?:\.\d+)?)\s*(?:@(\w+))?$/i
  ];
  
  for (const pattern of patterns) {
    const match = text.match(pattern);
    if (match) {
      const [, day, startTime, endTime, productCode, quantity, shop] = match;
      
      let date = new Date();
      if (day.toLowerCase() === 'heute') {
        // Use today
      } else if (day.toLowerCase() === 'morgen') {
        date.setDate(date.getDate() + 1);
      } else if (day.match(/^\d{4}-\d{2}-\d{2}$/)) {
        date = new Date(day);
      } else {
        // Map day abbreviations to dates in current week
        const dayMap = { 'MO': 0, 'DI': 1, 'MI': 2, 'DO': 3, 'FR': 4, 'SA': 5, 'SO': 6 };
        const dayIndex = dayMap[day.toUpperCase()];
        if (dayIndex !== undefined) {
          date = new Date(currentWeekStart);
          date.setDate(date.getDate() + dayIndex);
        }
      }
      
      return {
        day: formatDate(date),
        start_time: startTime,
        end_time: endTime || null,
        product_code: productCode.toUpperCase(),
        qty: parseFloat(quantity),
        shop: shop || null
      };
    }
  }
  
  return null;
}

function addProduction(date) {
  currentEditingProduction = null;
  openProductionModal({ day: date });
}

function editProduction(id) {
  const production = productionData.find(p => p.id === id);
  if (production) {
    currentEditingProduction = production;
    openProductionModal(production);
  }
}

function openProductionModal(production = {}) {
  const modal = $$('#productionModal');
  const title = $$('#modalTitle');
  
  if (currentEditingProduction) {
    title.textContent = 'Produktion bearbeiten';
    $$('#duplicateBtn').style.display = 'inline-block';
    $$('#deleteBtn').style.display = 'inline-block';
  } else {
    title.textContent = 'Neue Produktion';
    $$('#duplicateBtn').style.display = 'none';
    $$('#deleteBtn').style.display = 'none';
  }
  
  fillProductionForm(production);
  modal.classList.add('open');
}

function closeProductionModal() {
  $$('#productionModal').classList.remove('open');
  $$('#productSuggestions').classList.remove('open');
  currentEditingProduction = null;
}

function fillProductionForm(production) {
  $$('#productCode').value = production.product_code || '';
  $$('#quantity').value = production.qty || '';
  $$('#startTime').value = production.start_time || '';
  $$('#endTime').value = production.end_time || '';
  $$('#shop').value = production.shop || '';
  $$('#priority').value = production.priority || 5;
  $$('#assignedStaff').value = Array.isArray(production.assigned_staff) ? 
    production.assigned_staff.join(', ') : (production.assigned_staff || '');
  $$('#equipmentRequired').value = Array.isArray(production.equipment_required) ? 
    production.equipment_required.join(', ') : (production.equipment_required || '');
  $$('#productionNotes').value = production.note || '';
  
  // Store the date for new productions
  if (production.day) {
    $$('#productionForm').dataset.date = production.day;
  }
  
  updateRecipePreview();
}

async function showProductSuggestions() {
  const input = $$('#productCode');
  const query = input.value.toLowerCase();
  const suggestions = $$('#productSuggestions');
  
  if (query.length < 2) {
    suggestions.classList.remove('open');
    return;
  }
  
  const matches = itemsData.filter(item => 
    item.code.toLowerCase().includes(query) || 
    item.name.toLowerCase().includes(query)
  ).slice(0, 10);
  
  if (matches.length === 0) {
    suggestions.classList.remove('open');
    return;
  }
  
  suggestions.innerHTML = matches.map(item => `
    <div class="suggestion-item" onclick="selectProduct('${item.code}')">
      <strong>${item.code}</strong> - ${item.name}
      <div style="font-size: 12px; color: var(--text-muted);">
        Yield: ${item.yield_qty} ${item.yield_unit}
      </div>
    </div>
  `).join('');
  
  suggestions.classList.add('open');
}

function selectProduct(code) {
  $$('#productCode').value = code;
  $$('#productSuggestions').classList.remove('open');
  updateRecipePreview();
}

async function updateRecipePreview() {
  const productCode = $$('#productCode').value;
  const quantity = $$('#quantity').value;
  const preview = $$('#recipePreview');
  const details = $$('#recipeDetails');
  
  if (!productCode || !quantity) {
    preview.style.display = 'none';
    return;
  }
  
  try {
    const response = await api(`/api/items/${encodeURIComponent(productCode)}/bom/priced?qty=${quantity}`);
    const recipe = response.data;
    
    if (recipe.lines && recipe.lines.length > 0) {
      details.innerHTML = `
        <div style="margin-bottom: 12px;">
          <strong>Materialkosten: €${recipe.total_cost}</strong>
          ${recipe.stock_warnings.length > 0 ? 
            `<div style="color: #ff6b6b; font-size: 12px; margin-top: 4px;">
              ⚠️ ${recipe.stock_warnings.length} Materialien haben unzureichende Bestände
            </div>` : ''
          }
        </div>
        <div style="max-height: 150px; overflow-y: auto;">
          ${recipe.lines.map(line => `
            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid var(--border);">
              <span>${line.material_name}</span>
              <span>${line.qty} ${line.unit} (€${line.cost})</span>
            </div>
          `).join('')}
        </div>
      `;
      preview.style.display = 'block';
    } else {
      preview.style.display = 'none';
    }
  } catch (e) {
    console.error('Failed to load recipe preview:', e);
    preview.style.display = 'none';
  }
}

async function saveProduction() {
  try {
    const formData = {
      product_code: $$('#productCode').value,
      qty: Number($$('#quantity').value),
      start_time: $$('#startTime').value || null,
      end_time: $$('#endTime').value || null,
      shop: $$('#shop').value || null,
      priority: Number($$('#priority').value),
      assigned_staff: $$('#assignedStaff').value.split(',').map(s => s.trim()).filter(Boolean),
      equipment_required: $$('#equipmentRequired').value.split(',').map(s => s.trim()).filter(Boolean),
      note: $$('#productionNotes').value || null
    };
    
    if (currentEditingProduction) {
      formData.id = currentEditingProduction.id;
      formData.day = currentEditingProduction.day;
    } else {
      formData.day = $$('#productionForm').dataset.date;
    }
    
    if (!formData.product_code || !formData.qty || !formData.day) {
      toast('Produkt, Menge und Datum sind erforderlich');
      return;
    }
    
    await saveProductionItem(formData);
    closeProductionModal();
    await loadProductionWeek();
    toast(currentEditingProduction ? 'Produktion aktualisiert' : 'Produktion erstellt');
  } catch (e) {
    console.error('Failed to save production:', e);
    toast('Fehler beim Speichern der Produktion');
  }
}

async function saveProductionItem(data) {
  const endpoint = data.id ? `/api/plan/${data.id}` : '/api/plan';
  const method = data.id ? 'PUT' : 'POST';
  
  await api(endpoint, {
    method: method,
    body: JSON.stringify(data)
  });
}

async function duplicateProduction() {
  if (!currentEditingProduction) return;
  
  const duplicate = { ...currentEditingProduction };
  delete duplicate.id;
  duplicate.status = 'planned';
  
  try {
    await saveProductionItem(duplicate);
    closeProductionModal();
    await loadProductionWeek();
    toast('Produktion dupliziert');
  } catch (e) {
    console.error('Failed to duplicate production:', e);
    toast('Fehler beim Duplizieren der Produktion');
  }
}

async function deleteProduction() {
  if (!currentEditingProduction) return;
  
  if (!confirm('Sind Sie sicher, dass Sie diese Produktion löschen möchten?')) {
    return;
  }
  
  try {
    await api(`/api/plan/${currentEditingProduction.id}`, { method: 'DELETE' });
    closeProductionModal();
    await loadProductionWeek();
    toast('Produktion gelöscht');
  } catch (e) {
    console.error('Failed to delete production:', e);
    toast('Fehler beim Löschen der Produktion');
  }
}

async function moveProduction(productionId, newDate) {
  try {
    const production = productionData.find(p => p.id == productionId);
    if (!production) return;
    
    production.day = newDate;
    await saveProductionItem(production);
    await loadProductionWeek();
    toast('Produktion verschoben');
  } catch (e) {
    console.error('Failed to move production:', e);
    toast('Fehler beim Verschieben der Produktion');
  }
}

async function calculateAndDisplayCosts() {
  try {
    const weekStart = formatDate(currentWeekStart);
    const response = await api('/api/plan/calc', {
      method: 'POST',
      body: JSON.stringify({
        week_start: weekStart,
        include_labor: true,
        include_overhead: true
      })
    });
    
    const costs = response.data;
    $$('#materialCosts').textContent = `€${costs.total_material_cost || 0}`;
    $$('#laborCosts').textContent = `€${costs.total_labor_cost || 0}`;
    $$('#overheadCosts').textContent = `€${costs.total_overhead_cost || 0}`;
    $$('#totalCosts').textContent = `€${costs.grand_total || 0}`;
    
    // Show cost warnings if any
    const warnings = $$('#costWarnings');
    if (costs.warnings && costs.warnings.length > 0) {
      warnings.innerHTML = costs.warnings.map(warning => `
        <div style="color: #ffb24f; font-size: 12px; padding: 4px 8px; background: rgba(255, 178, 79, 0.1); border-radius: 4px; margin: 2px 0;">
          ⚠️ ${warning}
        </div>
      `).join('');
      warnings.style.display = 'block';
    } else {
      warnings.style.display = 'none';
    }
  } catch (e) {
    console.error('Failed to calculate costs:', e);
  }
}

function updateOptimizationMetrics() {
  // Calculate optimization metrics
  const totalBatches = productionData.length;
  const completedBatches = productionData.filter(p => p.status === 'completed').length;
  const efficiency = totalBatches > 0 ? (completedBatches / totalBatches * 100) : 0;
  
  $$('#efficiencyScore').textContent = `${efficiency.toFixed(0)}%`;
  $$('#totalBatches').textContent = totalBatches;
  
  // Simplified capacity and conflicts calculation
  $$('#capacityUtilization').textContent = '78%'; // Would be calculated based on actual capacity
  $$('#equipmentConflicts').textContent = '2'; // Would be calculated based on equipment scheduling
}

async function optimizeProduction() {
  try {
    toast('Produktionsoptimierung läuft...');
    
    // Simulate optimization process
    setTimeout(() => {
      const results = {
        efficiency_improvement: 12,
        cost_reduction: 8.5,
        time_savings: 45,
        recommendations: [
          'Batch ähnliche Produkte zusammen für bessere Ofenauslastung',
          'Verschiebe BROT_WEISS von 14:00 auf 10:00 für besseren Workflow',
          'Reduziere Rüstzeiten durch optimierte Reihenfolge'
        ]
      };
      
      showOptimizationResults(results);
    }, 2000);
  } catch (e) {
    console.error('Optimization failed:', e);
    toast('Fehler bei der Optimierung');
  }
}

function showOptimizationResults(results) {
  const modal = $$('#optimizationModal');
  const resultsDiv = $$('#optimizationResults');
  
  resultsDiv.innerHTML = `
    <div style="margin-bottom: 20px;">
      <h4>Verbesserungspotential</h4>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin: 12px 0;">
        <div class="metric-box">
          <div class="metric-value">+${results.efficiency_improvement}%</div>
          <div class="metric-label">Effizienz</div>
        </div>
        <div class="metric-box">
          <div class="metric-value">-€${results.cost_reduction}</div>
          <div class="metric-label">Kosteneinsparung</div>
        </div>
        <div class="metric-box">
          <div class="metric-value">${results.time_savings}min</div>
          <div class="metric-label">Zeitersparnis</div>
        </div>
      </div>
    </div>
    
    <div>
      <h4>Empfehlungen</h4>
      <ul style="margin: 12px 0; padding-left: 20px;">
        ${results.recommendations.map(rec => `<li style="margin: 8px 0;">${rec}</li>`).join('')}
      </ul>
    </div>
  `;
  
  modal.classList.add('open');
}

function closeOptimizationModal() {
  $$('#optimizationModal').classList.remove('open');
}

function applyOptimization() {
  toast('Optimierung wird angewendet...');
  closeOptimizationModal();
  
  setTimeout(async () => {
    await loadProductionWeek();
    toast('Optimierung erfolgreich angewendet');
  }, 1000);
}

async function validateProduction() {
  toast('Produktionsplan wird validiert...');
  
  // Simulate validation
  setTimeout(() => {
    toast('Validierung abgeschlossen - 2 Konflikte gefunden');
  }, 1000);
}

function generateRecommendations() {
  toast('Empfehlungen werden generiert...');
  
  setTimeout(() => {
    toast('3 neue Empfehlungen verfügbar');
  }, 1500);
}

async function calculateCosts() {
  await calculateAndDisplayCosts();
  toast('Kosten neu berechnet');
}

function exportCostReport() {
  toast('Kostenbericht wird exportiert...');
  
  setTimeout(() => {
    toast('Kostenbericht erfolgreich exportiert');
  }, 1000);
}

function showDetailedCosts() {
  toast('Detaillierte Kostenansicht wird geöffnet...');
}

function updateAutoSaveStatus(message, isError = false) {
  const status = $$('#autoSaveStatus span');
  status.textContent = message;
  
  if (isError) {
    status.style.color = '#ff6b6b';
  } else {
    status.style.color = '#6fe3a6';
  }
  
  setTimeout(() => {
    status.textContent = 'Auto-Speichern aktiv';
    status.style.color = '#6fe3a6';
  }, 3000);
}

async function saveAllChanges() {
  // This would save any pending changes
  // For now, just a placeholder
}

// Utility functions
function getStartOfWeek(date) {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
  return new Date(d.setDate(diff));
}

function formatDate(date) {
  return date.toISOString().split('T')[0];
}

function formatDisplayDate(date) {
  return date.toLocaleDateString('de-DE', { 
    day: '2-digit', 
    month: '2-digit' 
  });
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}
</script>

</body>
</html>
