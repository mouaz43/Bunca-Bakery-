<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bakeflow ‚Äî Artikel & Rezepte</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
  <style>
    .grid-top{ display:grid; gap:10px; grid-template-columns: 1fr auto auto }
    @media (max-width: 720px){ .grid-top{ grid-template-columns:1fr } }
    .row-actions{ display:flex; gap:8px; justify-content:flex-end }
    .del{ background:rgba(255,0,0,.08); border-color:rgba(255,0,0,.25) }
    /* Drawer recipe */
    .drawer{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:14px; }
    .drawer.open{ display:flex }
    .sheet{ width:min(920px,96vw); background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); overflow:hidden }
    .sheet-head{ padding:12px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:10px }
    .sheet-body{ padding:12px; display:grid; gap:12px }
    .mini{ font-size:12px; color:var(--text-muted) }
    .pill{ padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--border); font-size:12px }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace }
    .suggest{ position:absolute; z-index:5; background:var(--card); border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); display:none; }
    .suggest.open{ display:block }
    .suggest div{ padding:6px 8px; cursor:pointer }
    .suggest div:hover{ background:rgba(255,255,255,.06) }
    .rel{ position:relative }
    .right{text-align:right}
  </style>
</head>
<body>

<header class="header">
  <nav class="nav">
    <div class="brand">üçû Bakeflow ‚Äî Artikel & Rezepte</div>
    <div class="menu-wrap">
      <button class="btn" onclick="location.href='/dashboard.html'">Dashboard</button>
      <button class="btn" onclick="location.href='/materials.html'">Rohwaren</button>
      <button class="btn" onclick="location.href='/plan.html'">Plan</button>
      <button class="btn danger" onclick="logout()">Logout</button>
    </div>
  </nav>
</header>

<main class="container">
  <section class="card">
    <div class="card-title-row">
      <h2 style="margin:0">Artikel</h2>
      <div class="grid-top">
        <input id="search" class="input" placeholder="Suchen‚Ä¶ (Code / Name / Kategorie)"/>
        <button class="btn" id="newBtn">+ Neuer Artikel</button>
        <button class="btn" id="reloadBtn">Neu laden</button>
      </div>
    </div>

    <div class="card-pad">
      <div class="table-wrap">
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th>Code</th>
              <th>Name</th>
              <th>Kategorie</th>
              <th>Yield Qty</th>
              <th>Yield Unit</th>
              <th>Notiz</th>
              <th class="right">Aktionen</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="7" class="muted">Lade‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- Recipe Drawer -->
<div id="recipeDrawer" class="drawer">
  <div class="sheet">
    <div class="sheet-head">
      <div>
        <div id="rTitle" style="font-weight:800">Rezept</div>
        <div class="mini" id="rYield"></div>
      </div>
      <div class="row-gap">
        <input id="rScale" type="number" class="input mono" step="0.01" style="width:160px" value="1"/>
        <button class="btn" id="rCostBtn">Kosten</button>
        <button class="btn primary" id="rSaveBtn">Speichern</button>
        <button class="btn" onclick="Drawer.close()">Schlie√üen</button>
      </div>
    </div>
    <div class="sheet-body">
      <div class="table-wrap">
        <table class="table" id="rTable">
          <thead>
            <tr>
              <th style="width:40%">Material</th>
              <th class="right" style="width:16%">Menge</th>
              <th style="width:16%">Einheit</th>
              <th class="right" style="width:18%">‚Ç¨</th>
              <th class="right" style="width:10%">‚Äî</th>
            </tr>
          </thead>
          <tbody id="rBody">
            <tr><td colspan="5" class="muted">Noch kein Rezept</td></tr>
          </tbody>
        </table>
      </div>
      <button class="btn" id="rAdd">+ Zutat</button>
      <div class="mini">Suche greift auf Rohwaren zu. Kosten werden live pro Zeile kalkuliert.</div>
    </div>
  </div>
</div>

<script>
function logout(){ api('/api/logout',{method:'POST'}).then(()=>location.href='/login.html'); }

let DATA = [];
let CURRENT = null; // current item {code,name,yield_qty,yield_unit}
let R_LINES = [];   // [{material_code, name, qty, unit, cost}]

function rowHTML(it){
  return `<tr data-code="${it.code}">
    <td><input class="input mono" value="${it.code||''}" data-k="code"/></td>
    <td><input class="input" value="${it.name||''}" data-k="name"/></td>
    <td><input class="input" value="${it.category||''}" data-k="category"/></td>
    <td><input class="input mono" type="number" step="0.01" value="${Number(it.yield_qty||1)}" data-k="yield_qty"/></td>
    <td>
      <select class="input" data-k="yield_unit">
        ${['pcs','g','ml'].map(u=>`<option ${it.yield_unit===u?'selected':''} value="${u}">${u}</option>`).join('')}
      </select>
    </td>
    <td><input class="input" value="${it.note||''}" data-k="note"/></td>
    <td class="right">
      <div class="row-actions">
        <button class="btn" onclick="saveItem(this)">Speichern</button>
        <button class="btn" onclick="openRecipe('${it.code}', this)">Rezept</button>
        <button class="btn del" onclick="delItem('${it.code}')">L√∂schen</button>
      </div>
    </td>
  </tr>`;
}
async function load(){
  const r = await api('/api/items');
  DATA = r.data || [];
  const tb = document.getElementById('tbody');
  tb.innerHTML = DATA.map(rowHTML).join('') || `<tr><td colspan="7" class="muted">Keine Eintr√§ge</td></tr>`;
  makeTableSortable(document.getElementById('tbl'));
}
function valuesOf(tr){
  const obj = {};
  $$$('input,select', tr).forEach(el=>{
    obj[el.dataset.k] = (el.type==='number' && el.value!=='') ? Number(el.value) : (el.value || null);
  });
  return obj;
}
async function saveItem(btn){
  const tr = btn.closest('tr');
  const v = valuesOf(tr);
  await api('/api/items', { method:'POST', body: JSON.stringify(v) });
  toast('Artikel gespeichert');
}
async function delItem(code){
  if (!confirm(`Artikel ${code} l√∂schen (inkl. Rezept & Planzeilen)?`)) return;
  await api('/api/items/'+encodeURIComponent(code), { method:'DELETE' });
  await load(); toast('Artikel gel√∂scht');
}
function addNew(){
  const tb = document.getElementById('tbody');
  tb.insertAdjacentHTML('afterbegin', rowHTML({ code:'', name:'', category:'', yield_qty:1, yield_unit:'pcs', note:'' }));
}

/* ---------- Recipe drawer ---------- */
function rLineHTML(L, idx){
  const cost = Number(L.cost||0);
  return `<tr data-idx="${idx}">
    <td class="rel">
      <input class="input" placeholder="Material suchen‚Ä¶" value="${L.name||L.material_code||''}" data-k="name"/>
      <div class="suggest" id="sg-${idx}"></div>
    </td>
    <td class="right"><input class="input mono" type="number" step="0.01" value="${Number(L.qty||0)||0}" data-k="qty"/></td>
    <td>
      <select class="input" data-k="unit">
        ${['g','kg','ml','l','pcs'].map(u=>`<option ${L.unit===u?'selected':''} value="${u}">${u}</option>`).join('')}
      </select>
    </td>
    <td class="right mono" data-k="cost">${cost ? cost.toFixed(2) : ''}</td>
    <td class="right"><button class="btn del" onclick="rRemove(${idx})">x</button></td>
  </tr>`;
}
function rRender(){
  const tb = document.getElementById('rBody');
  tb.innerHTML = R_LINES.length ? R_LINES.map(rLineHTML).join('') : `<tr><td colspan="5" class="muted">Noch kein Rezept</td></tr>`;
  // attach behaviors
  $$$('#rBody tr').forEach(tr=>{
    const idx = Number(tr.dataset.idx);
    const name = tr.querySelector('input[data-k="name"]');
    const qty  = tr.querySelector('input[data-k="qty"]');
    const unit = tr.querySelector('select[data-k="unit"]');
    const sgBox= tr.querySelector('.suggest');
    // search
    let t;
    name.addEventListener('input', async (e)=>{
      const q = e.target.value.trim(); clearTimeout(t);
      if (!q) { sgBox.classList.remove('open'); sgBox.innerHTML=''; return; }
      t = setTimeout(async ()=>{
        const res = await api('/api/materials/search?q=' + encodeURIComponent(q));
        sgBox.innerHTML = (res.data||[]).map(m=>`<div data-code="${m.code}" data-unit="${m.base_unit}" data-ppu="${m.price_per_unit}">${m.name} <span class="mini mono">(${m.code})</span></div>`).join('');
        sgBox.classList.add('open');
        $$$('div', sgBox).forEach(el=>{
          el.onclick = ()=>{
            const code = el.dataset.code;
            const base = el.dataset.unit;
            const ppu  = Number(el.dataset.ppu||0);
            R_LINES[idx].material_code = code;
            R_LINES[idx].name = el.textContent;
            R_LINES[idx].base_unit = base;
            R_LINES[idx].price_per_unit = ppu;
            name.value = el.textContent;
            sgBox.classList.remove('open');
            rRecalc(idx);
          };
        });
      }, 150);
    });
    name.addEventListener('blur', ()=> setTimeout(()=> sgBox.classList.remove('open'), 180));

    // qty/unit change
    qty.addEventListener('input', ()=> rRecalc(idx));
    unit.addEventListener('change', ()=> rRecalc(idx));
  });
}
async function rRecalc(idx){
  const L = R_LINES[idx];
  const tr = $(`#rBody tr[data-idx="${idx}"]`);
  const qty = Number(tr.querySelector('input[data-k="qty"]').value||0);
  const unit = tr.querySelector('select[data-k="unit"]').value;
  R_LINES[idx].qty = qty; R_LINES[idx].unit = unit;
  if (!L.material_code){ tr.querySelector('[data-k="cost"]').textContent=''; return; }
  try{
    const r = await api('/api/calc/line', { method:'POST', body: JSON.stringify({ material_code:L.material_code, qty, unit }) });
    R_LINES[idx].cost = Number(r.data?.cost||0);
    tr.querySelector('[data-k="cost"]').textContent = R_LINES[idx].cost ? R_LINES[idx].cost.toFixed(2) : '';
  }catch{ tr.querySelector('[data-k="cost"]').textContent=''; }
}
function rAdd(){ R_LINES.push({ material_code:null, name:'', qty:0, unit:'g', cost:0 }); rRender(); }
function rRemove(i){ R_LINES.splice(i,1); rRender(); }
async function openRecipe(code, btn){
  const tr = btn.closest('tr');
  const v = valuesOf(tr);
  CURRENT = { code: v.code, name: v.name, yield_qty: v.yield_qty||1, yield_unit: v.yield_unit||'pcs' };
  document.getElementById('rTitle').textContent = `Rezept: ${CURRENT.code} ‚Äî ${CURRENT.name||''}`;
  document.getElementById('rYield').textContent = `Menge (${CURRENT.yield_qty} ${CURRENT.yield_unit})`;
  document.getElementById('rScale').value = CURRENT.yield_qty;

  // load bom
  const r = await api(`/api/items/${encodeURIComponent(CURRENT.code)}/bom`);
  R_LINES = (r.data||[]).map(x=>({ material_code:x.material_code, name:x.material_name||x.material_code, qty:Number(x.qty), unit:x.unit, cost:0 }));
  Drawer.open('#recipeDrawer'); rRender();
}
async function rSave(){
  const clean = R_LINES.filter(x=>x.material_code && Number(x.qty)>0).map(x=>({ material_code:x.material_code, qty:Number(x.qty), unit:x.unit||'g' }));
  await api(`/api/items/${encodeURIComponent(CURRENT.code)}/bom`, { method:'POST', body: JSON.stringify({ lines: clean }) });
  toast('Rezept gespeichert'); Drawer.close();
}
async function rCost(){
  const qty = Number(document.getElementById('rScale').value || CURRENT.yield_qty || 1);
  try{
    const r = await api(`/api/items/${encodeURIComponent(CURRENT.code)}/bom/priced?qty=${qty}`);
    const total = Number(r.data?.total_cost||0);
    toast(`Kosten f√ºr ${qty} ${CURRENT.yield_unit}: ${total.toFixed(2)} ‚Ç¨`);
  }catch{ toast('Kalkulation fehlgeschlagen'); }
}

document.getElementById('newBtn').addEventListener('click', addNew);
document.getElementById('reloadBtn').addEventListener('click', load);
attachClientFilter(document.getElementById('search'), document.getElementById('tbl'));

// drawer buttons
document.getElementById('rAdd').addEventListener('click', rAdd);
document.getElementById('rSaveBtn').addEventListener('click', rSave);
document.getElementById('rCostBtn').addEventListener('click', rCost);

(async function(){
  const u = await sessionInfo(); if(!u){ location.href='/login.html'; return; }
  await load();
})();
</script>

</body>
</html>
