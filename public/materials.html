<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bunca Bakeryflow — Rohwaren</title>
  <link rel="stylesheet" href="/styles.css"/>
  <script defer src="/js/app.js"></script>
</head>
<body>
<header class="header">
  <nav class="nav">
    <div class="brand">Bunca Bakeryflow <small>Rohwaren</small></div>
    <div class="menu">
      <button class="btn" onclick="location.href='/materials.html'">Rohwaren</button>
      <button class="btn" onclick="location.href='/items.html'">Rezepte</button>
      <button class="btn" onclick="location.href='/plan.html'">Produktionsplan</button>
      <button class="btn" onclick="location.href='/admin.html'">Admin</button>
      <button class="btn danger" onclick="logout()">Logout</button>
    </div>
  </nav>
</header>

<main class="container">
  <div class="card">
    <div class="card-head">
      <div class="row">
        <strong>Rohwaren verwalten</strong>
        <span id="countBadge" class="badge">0</span>
      </div>
      <div class="toolbar">
        <input id="q" class="search" type="text" placeholder="Suchen nach Name oder Code">
        <button class="btn primary" onclick="openMaterialModal()">Neu</button>
        <button class="btn" onclick="openImport()">Import</button>
      </div>
    </div>
    <div class="card-body">
      <table class="table" id="matTable">
        <thead>
          <tr>
            <th>Code</th><th>Name</th><th>Einheit</th><th>Preis/Einheit</th><th>Bestand</th><th>Min.</th><th>Lieferant</th><th></th>
          </tr>
        </thead>
        <tbody id="matBody">
          <tr><td colspan="8"><div class="skeleton"></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</main>

<!-- Modal -->
<div id="modalHost"></div>

<script>
let MATERIALS = [];
let API_KIND = 'materials'; // or 'products'

(async function init(){
  const user = await sessionInfo(); if(!user){ location.href='/login.html'; return; }
  await detectApiKind();
  await loadMaterials();
  document.getElementById('q').addEventListener('input', renderMaterials);
})();

async function detectApiKind(){
  try{
    await api('/api/materials');
    API_KIND = 'materials';
  }catch(e){
    API_KIND = 'products';
  }
}

async function loadMaterials(){
  try{
    const endpoint = API_KIND==='materials' ? '/api/materials' : '/api/products';
    const res = await api(endpoint);
    MATERIALS = (res.data || res) ?? [];
    renderMaterials();
  }catch(err){
    console.error(err); toast('Fehler beim Laden der Rohwaren', 'error');
  }
}

function renderMaterials(){
  const q = document.getElementById('q').value.toLowerCase();
  const body = document.getElementById('matBody');
  const rows = MATERIALS.filter(r =>
    (!q) || String(r.name).toLowerCase().includes(q) || String(r.code).toLowerCase().includes(q)
  );
  document.getElementById('countBadge').textContent = rows.length;

  if(!rows.length){
    body.innerHTML = `<tr><td colspan="8" class="muted">Keine Einträge</td></tr>`;
    return;
  }

  body.innerHTML = rows.map(r=>{
    const unit = r.base_unit || r.unit || 'kg';
    const price = Number(r.price_per_unit ?? r.unit_price ?? 0);
    const stock = Number(r.current_stock ?? 0);
    const min   = Number(r.min_stock ?? 0);
    const sup   = r.supplier || '';
    const low   = stock <= min && (min>0);
    return `
      <tr class="row">
        <td>${escape(r.code)}</td>
        <td>${escape(r.name)}</td>
        <td>${escape(unit)}</td>
        <td>${formatCurrency(price)}</td>
        <td>${formatNumber(stock,2)}</td>
        <td>${formatNumber(min,2)} ${low?`<span class="badge warn">niedrig</span>`:''}</td>
        <td>${escape(sup)}</td>
        <td class="row right">
          <button class="btn" onclick='openMaterialModal(${JSON.stringify(slim(r))})'>Bearbeiten</button>
          <button class="btn danger" onclick='deleteMaterial("${r.code}")'>Löschen</button>
        </td>
      </tr>`;
  }).join('');
}

function slim(r){
  return {
    code:r.code,
    name:r.name,
    unit:r.base_unit||r.unit||'kg',
    price:Number(r.price_per_unit ?? r.unit_price ?? 0),
    stock:Number(r.current_stock ?? 0),
    min:Number(r.min_stock ?? 0),
    supplier:r.supplier||''
  };
}

function openMaterialModal(data){
  const isEdit = !!data;
  const host = document.getElementById('modalHost');
  host.innerHTML = `
    <div class="modal-wrap" onclick="closeModal(event)">
      <div class="modal" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
        <div class="head">${isEdit?'Rohware bearbeiten':'Rohware anlegen'}</div>
        <div class="body">
          <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
            <div>
              <label>Code</label>
              <input id="m-code" type="text" ${isEdit?'disabled':''} value="${data?escapeAttr(data.code):''}">
            </div>
            <div>
              <label>Name</label>
              <input id="m-name" type="text" value="${data?escapeAttr(data.name):''}">
            </div>
            <div>
              <label>Einheit</label>
              <input id="m-unit" type="text" value="${data?escapeAttr(data.unit):'kg'}">
            </div>
            <div>
              <label>Preis/Einheit</label>
              <input id="m-price" type="number" step="0.0001" value="${data?data.price:0}">
            </div>
            <div>
              <label>Bestand</label>
              <input id="m-stock" type="number" step="0.001" value="${data?data.stock:0}">
            </div>
            <div>
              <label>Min. Bestand</label>
              <input id="m-min" type="number" step="0.001" value="${data?data.min:0}">
            </div>
            <div style="grid-column:1/-1">
              <label>Lieferant</label>
              <input id="m-supplier" type="text" value="${data?escapeAttr(data.supplier):''}">
            </div>
          </div>
        </div>
        <div class="foot">
          <button class="btn" onclick="document.getElementById('modalHost').innerHTML=''">Abbrechen</button>
          <button class="btn primary" onclick="${isEdit?'saveMaterialEdit()':'saveMaterialCreate()'}">${isEdit?'Speichern':'Anlegen'}</button>
        </div>
      </div>
    </div>`;
  // keep reference of edit item
  openMaterialModal._edit = data || null;
}

function closeModal(ev){ if(ev.target.classList.contains('modal-wrap')) document.getElementById('modalHost').innerHTML=''; }

async function saveMaterialCreate(){
  try{
    const payload = readForm();
    if(API_KIND==='materials'){
      await api('/api/materials',{method:'POST', body:payload});
    }else{
      await api('/api/products',{method:'POST', body:{
        code:payload.code, name:payload.name, unit:payload.base_unit,
        unit_price:payload.price_per_unit, group:'', supplier:payload.supplier
      }});
    }
    toast('Rohware angelegt','success');
    document.getElementById('modalHost').innerHTML='';
    await loadMaterials();
  }catch(e){ console.error(e); toast('Speichern fehlgeschlagen','error'); }
}

async function saveMaterialEdit(){
  try{
    const payload = readForm();
    const code = openMaterialModal._edit.code;
    if(API_KIND==='materials'){
      await api('/api/materials/'+encodeURIComponent(code),{method:'PUT', body:{
        name:payload.name, base_unit:payload.base_unit, price_per_unit:payload.price_per_unit,
        current_stock:payload.current_stock, min_stock:payload.min_stock, supplier:payload.supplier
      }});
    }else{
      await api('/api/products/'+encodeURIComponent(code),{method:'PUT', body:{
        name:payload.name, unit:payload.base_unit, unit_price:payload.price_per_unit,
        group:'', supplier:payload.supplier, active:true
      }});
    }
    toast('Rohware gespeichert','success');
    document.getElementById('modalHost').innerHTML='';
    await loadMaterials();
  }catch(e){ console.error(e); toast('Speichern fehlgeschlagen','error'); }
}

async function deleteMaterial(code){
  if(!confirm('Wirklich löschen?')) return;
  try{
    if(API_KIND==='materials'){
      await api('/api/materials/'+encodeURIComponent(code),{method:'DELETE'});
    }else{
      await api('/api/products/'+encodeURIComponent(code),{method:'DELETE'});
    }
    toast('Gelöscht','info');
    await loadMaterials();
  }catch(e){ console.error(e); toast('Löschen fehlgeschlagen','error'); }
}

function readForm(){
  const g = id=>document.getElementById(id).value;
  return {
    code:g('m-code').trim(),
    name:g('m-name').trim(),
    base_unit:g('m-unit').trim()||'kg',
    price_per_unit:Number(g('m-price')||0),
    current_stock:Number(g('m-stock')||0),
    min_stock:Number(g('m-min')||0),
    supplier:g('m-supplier').trim()
  };
}

/* Import */
function openImport(){
  const host = document.getElementById('modalHost');
  host.innerHTML = `
    <div class="modal-wrap" onclick="closeModal(event)">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="head">Rohwaren importieren</div>
        <div class="body">
          <p class="muted">XLSX oder CSV mit Spalten: code, name, unit/base_unit, unit_price/price_per_unit, current_stock, min_stock, supplier</p>
          <input id="impFile" type="file" accept=".xlsx,.csv"/>
        </div>
        <div class="foot">
          <button class="btn" onclick="document.getElementById('modalHost').innerHTML=''">Abbrechen</button>
          <button class="btn primary" onclick="doImport()">Import starten</button>
        </div>
      </div>
    </div>`;
}
async function doImport(){
  const file = document.getElementById('impFile').files[0];
  if(!file) return toast('Bitte Datei wählen','warning');
  const fd = new FormData();
  fd.append('file', file);
  fd.append('type', API_KIND==='materials' ? 'products' : 'products'); // server import expects "products"
  try{
    const r = await fetch('/api/import/file',{method:'POST', body:fd});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    toast('Import erfolgreich: '+(j.imported||0)+' Zeilen','success');
    document.getElementById('modalHost').innerHTML='';
    await loadMaterials();
  }catch(e){ console.error(e); toast('Import fehlgeschlagen','error'); }
}

/* utils */
function formatCurrency(n,c='EUR'){ return new Intl.NumberFormat('de-DE',{style:'currency',currency:c}).format(Number(n||0)); }
function formatNumber(n,d=2){ return new Intl.NumberFormat('de-DE',{minimumFractionDigits:d,maximumFractionDigits:d}).format(Number(n||0)); }
function escape(s){ return String(s??'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
function escapeAttr(s){ return escape(s).replace(/"/g,'&quot;'); }
</script>
</body>
</html>
